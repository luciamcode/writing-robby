<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å’Œé¢¨ åŸ·ç­†ãƒé–“ãƒ»çœŸæ‰“</title>
<style>
    :root {
        --bg-paper: #fcfaf2; --text: #2b2b2b; --bar-bg: #fdfdfd; --border: #dcd3b2;
        --accent: #165e83; --selected: #e3eff7; --danger: #b7282e; --btn-text: #666;
        --memo-bg: #f0f0e8; --highlight: #fff3b8;
        /* è‰²ãƒ©ãƒ™ãƒ«ç”¨ */
        --c-red: #ffcdd2; --c-blue: #bbdefb; --c-green: #c8e6c9; --c-yellow: #fff9c4; --c-purple: #e1bee7;
    }
    body.dark-mode {
        --bg-paper: #202124; --text: #e8eaed; --bar-bg: #303134; --border: #5f6368;
        --accent: #8ab4f8; --selected: #3c4043; --danger: #f28b82; --btn-text: #aaa;
        --memo-bg: #2d2e30; --highlight: #5f6368;
        --c-red: #5c2b2b; --c-blue: #1f3a52; --c-green: #254227; --c-yellow: #4a4218; --c-purple: #3a2342;
    }
    body {
        font-family: "Yu Mincho", "Hiragino Mincho ProN", serif;
        background: var(--bg-paper); color: var(--text);
        margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
    }
    textarea, input { font-family: inherit; }
    .icon { width: 20px; height: 20px; fill: currentColor; vertical-align: middle; }

    /* --- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ãƒ– (æœ€ä¸Šéƒ¨) --- */
    .project-bar {
        height: 36px; background: var(--bar-bg); border-bottom: 1px solid var(--border);
        display: flex; overflow-x: auto; white-space: nowrap; align-items: flex-end; padding: 0 5px;
        flex-shrink: 0;
    }
    .p-tab {
        padding: 6px 12px; font-size: 13px; color: var(--btn-text); border: 1px solid transparent;
        border-bottom: none; border-radius: 6px 6px 0 0; margin-right: 2px; cursor: pointer;
    }
    .p-tab.active {
        background: var(--bg-paper); color: var(--accent); border-color: var(--border);
        font-weight: bold; position: relative; top: 1px;
    }
    .p-add-btn { padding: 6px 10px; color: var(--accent); cursor: pointer; }

    /* --- ãƒ„ãƒ¼ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
    .header {
        height: 44px; background: var(--bar-bg); border-bottom: 1px solid var(--border);
        display: flex; align-items: center; padding: 0 10px; justify-content: space-between;
        flex-shrink: 0; z-index: 10;
    }
    .mode-switch { display: flex; background: rgba(0,0,0,0.05); border-radius: 6px; padding: 2px; }
    .m-btn {
        padding: 4px 10px; border: none; background: transparent; color: var(--btn-text); font-size: 12px; cursor: pointer;
    }
    .m-btn.active { background: var(--bg-paper); color: var(--accent); font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .count-info { font-size: 10px; color: var(--btn-text); text-align: right; line-height: 1.2; margin-left: 10px; }
    
    /* --- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ --- */
    #mainArea { flex: 1; overflow: hidden; position: relative; }
    
    /* ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼ */
    #listView { 
        height: 100%; overflow-y: auto; padding: 10px 10px 100px 10px; 
        box-sizing: border-box; -webkit-overflow-scrolling: touch; 
    }
    
    /* å°èª¬ãƒ“ãƒ¥ãƒ¼ */
    #novelView { 
        height: 100%; display: none; padding: 20px 15px 100px 15px; 
        box-sizing: border-box; overflow-y: auto; 
    }
    #novelText { 
        width: 100%; min-height: 100%; border: none; background: transparent; 
        color: var(--text); font-size: 16px; line-height: 2.0; resize: none; outline: none; 
    }
    /* ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼ç”¨ã®ãƒ€ãƒŸãƒ¼ä½™ç™½ */
    #novelText::after { content: ""; display: block; height: 50vh; }

    /* --- ãƒãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« --- */
    ul { list-style: none; padding: 0; margin: 0; }
    ul ul { padding-left: 20px; border-left: 1px dashed var(--border); margin-top: 2px; }
    .node { margin-bottom: 6px; }
    .node-box {
        background: var(--bar-bg); border: 1px solid transparent; border-radius: 4px;
        transition: background 0.2s; position: relative;
    }
    .node-content { display: flex; align-items: flex-start; padding: 6px 2px; }
    
    /* è‰²ãƒ©ãƒ™ãƒ« */
    .node-box[data-color="red"] { background: var(--c-red); }
    .node-box[data-color="blue"] { background: var(--c-blue); }
    .node-box[data-color="green"] { background: var(--c-green); }
    .node-box[data-color="yellow"] { background: var(--c-yellow); }
    .node-box[data-color="purple"] { background: var(--c-purple); }

    .node-box.selected { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent) inset; }
    
    textarea.row-text {
        flex: 1; border: none; background: transparent; color: var(--text);
        font-size: 16px; line-height: 1.5; resize: none; outline: none; min-height: 24px;
        margin-left: 4px;
    }
    
    /* ãƒ¡ãƒ¢æ¬„ */
    .node-memo {
        display: none; width: 100%; padding: 4px 8px; font-size: 12px; color: var(--btn-text);
        background: var(--memo-bg); border-top: 1px dashed var(--border);
        box-sizing: border-box; border-radius: 0 0 4px 4px;
    }
    .node-memo.show { display: block; }
    .memo-input { width: 100%; background: transparent; border: none; outline: none; resize: none; color: inherit; }

    /* ãƒãƒ¼ã‚«ãƒ¼ */
    mark { background: var(--highlight); color: inherit; padding: 0 2px; }

    /* --- ãƒ•ãƒƒã‚¿ãƒ¼ (2æ®µæ§‹ãˆ) --- */
    .footer {
        position: fixed; bottom: 0; left: 0; right: 0; z-index: 20;
        background: var(--bar-bg); border-top: 1px solid var(--border);
        padding-bottom: env(safe-area-inset-bottom);
        box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    }
    .toolbar-row { height: 42px; display: flex; justify-content: space-around; align-items: center; }
    .f-btn {
        flex: 1; height: 100%; display: flex; flex-direction: column; 
        justify-content: center; align-items: center; font-size: 9px; 
        color: var(--btn-text); border: none; background: none; cursor: pointer;
    }
    .f-btn:active { background: rgba(0,0,0,0.05); }
    
    /* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿æ™‚ã®ãƒ•ãƒƒã‚¿ãƒ¼åˆ¶å¾¡ */
    body.select-mode .f-normal { display: none; }
    body.select-mode .f-select { display: flex; }
    .f-select { display: none; }
    
    /* é¸æŠãƒã‚§ãƒƒã‚¯ */
    .check-circle { 
        width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; 
        margin-right: 4px; display: none; flex-shrink: 0; margin-top: 4px;
    }
    body.select-mode .check-circle { display: block; }
    .node-box.selected .check-circle { background: var(--accent); border-color: var(--accent); }

    /* --- å„ç¨®ãƒ‘ãƒãƒ« --- */
    .panel {
        position: fixed; top: 80px; left: 10px; right: 10px; bottom: 60px;
        background: var(--bar-bg); border: 1px solid var(--border); border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100; display: none;
        flex-direction: column;
    }
    .panel.show { display: flex; }
    .panel-header { padding: 10px; border-bottom: 1px solid var(--border); font-weight: bold; display: flex; justify-content: space-between; }
    .panel-body { flex: 1; overflow-y: auto; padding: 10px; }
    
    /* æ¤œç´¢ãƒªã‚¹ãƒˆ */
    .search-item { padding: 8px; border-bottom: 1px solid var(--border); cursor: pointer; }
    .search-item:active { background: var(--selected); }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    .menu-popup {
        position: absolute; top: 40px; right: 10px; width: 220px;
        background: var(--bar-bg); border: 1px solid var(--border); border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 101; display: none;
    }
    .menu-popup.show { display: block; }
    .menu-row { padding: 10px 15px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; }
    .menu-row:last-child { border-bottom: none; }

    .color-swatch { width: 16px; height: 16px; border-radius: 4px; border: 1px solid #ddd; display: inline-block; margin-right: 4px; }
</style>
</head>
<body>

<div class="project-bar" id="projectBar">
    <div class="p-tab active">æœ¬ç·¨</div>
    <div class="p-add-btn" onclick="addProject()">ï¼‹</div>
</div>

<div class="header">
    <div class="mode-switch">
        <button class="m-btn active" onclick="setMode('list')">æ§‹æˆ</button>
        <button class="m-btn" onclick="setMode('novel')">å°èª¬</button>
    </div>
    
    <div style="flex:1"></div>
    
    <div class="count-info" id="countInfo">
        å…¨: 0<br>é¸æŠ: 0
    </div>
    
    <div class="f-btn" onclick="toggleSearch()" style="width:40px; margin-left:10px;">
        <svg class="icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
    </div>
    <div class="f-btn" onclick="toggleMenu()" style="width:40px;">
        <svg class="icon" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
    </div>
</div>

<div class="menu-popup" id="mainMenu">
    <div class="menu-row" onclick="toggleDark()">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</div>
    <div class="menu-row" onclick="toggleTemplate()">ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæŒ¿å…¥</div>
    <div class="menu-row" onclick="toggleImportExport()">floppy_disk ä¿å­˜/èª­è¾¼ (MD/OPML)</div>
    <div class="menu-row" onclick="resetProject()" style="color:var(--danger)">ğŸ—‘ ã‚¿ãƒ–å‰Šé™¤ãƒ»åˆæœŸåŒ–</div>
</div>

<div class="panel" id="searchPanel">
    <div class="panel-header">
        <span>æ¤œç´¢</span>
        <span onclick="toggleSearch()">âœ•</span>
    </div>
    <div style="padding:10px; border-bottom:1px solid var(--border);">
        <input type="text" id="searchInput" placeholder="æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ (æ­£è¦è¡¨ç¾å¯)" style="width:100%; padding:8px; box-sizing:border-box;">
        <div style="margin-top:5px; text-align:right;">
            <button onclick="runSearch()">å®Ÿè¡Œ</button>
        </div>
    </div>
    <div class="panel-body" id="searchResultList"></div>
</div>

<div class="panel" id="ioPanel">
    <div class="panel-header"><span>ä¿å­˜ãƒ»èª­è¾¼</span><span onclick="toggleImportExport()">âœ•</span></div>
    <div class="panel-body">
        <h4>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h4>
        <button onclick="exportData('txt')">å…¨æ–‡ãƒ†ã‚­ã‚¹ãƒˆ (.txt)</button>
        <button onclick="exportData('md')">Markdown (.md)</button>
        <button onclick="exportData('opml')">OPML (.opml)</button>
        <hr>
        <h4>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h4>
        <input type="file" id="fileInput" onchange="importFile(this)">
    </div>
</div>

<div class="panel" id="tplPanel">
    <div class="panel-header"><span>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</span><span onclick="toggleTemplate()">âœ•</span></div>
    <div class="panel-body">
        <div class="search-item" onclick="insertTemplate('ã€ç™»å ´äººç‰©ã€‘\nãƒ»åå‰ï¼š\nãƒ»å¹´é½¢ï¼š\nãƒ»æ€§æ ¼ï¼š')">äººç‰©è¨­å®š</div>
        <div class="search-item" onclick="insertTemplate('ã€å ´é¢ã€‘\nãƒ»å ´æ‰€ï¼š\nãƒ»æ™‚é–“ï¼š\nãƒ»ç›®çš„ï¼š')">ã‚·ãƒ¼ãƒ³è¨­å®š</div>
        <div class="search-item" onclick="insertTemplate('â€¦â€¦\nã€€ã€€ã€€******\nâ€¦â€¦')">å ´é¢è»¢æ›ï¼ˆã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ï¼‰</div>
    </div>
</div>


<div id="mainArea">
    <div id="listView"><ul id="rootList"></ul></div>
    <div id="novelView"><textarea id="novelText" oninput="handleNovelInput()" onclick="handleNovelInput()"></textarea></div>
</div>

<div class="footer">
    <div class="toolbar-row">
        <div class="f-btn" onclick="undo()" style="flex:0.6"><svg class="icon" viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>æˆ»ã™</div>
        <div class="f-btn" onclick="redo()" style="flex:0.6"><svg class="icon" viewBox="0 0 24 24"><path d="M18.4 10.6C16.55 9 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg>é€²ã‚€</div>
        
        <div style="width:1px; background:var(--border); height:60%;"></div>

        <div class="f-btn f-normal" onclick="moveIndent(-1)">
             <svg class="icon" viewBox="0 0 24 24"><path d="M11 17h10v-2H11v2zm-8-5l4 4V8l-4 4zm0 9h18v-2H3v2zM3 3v2h18V3H3zm8 6h10V7H11v2zm10 4H11v-2h10v2z"/></svg>å­—ä¸Šã’
        </div>
        <div class="f-btn f-normal" onclick="moveIndent(1)">
             <svg class="icon" viewBox="0 0 24 24"><path d="M3 21h18v-2H3v2zM3 8v8l4-4-4-4zm8 9h10v-2H11v2zM3 3v2h18V3H3zm8 6h10V7H11v2zm0 4h10v-2H11v2z"/></svg>å­—ä¸‹ã’
        </div>
        <div class="f-btn f-normal" onclick="addNode()" style="color:var(--accent)">
            <svg class="icon" style="width:28px;height:28px;" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>
        </div>
        <div class="f-btn f-normal" onclick="toggleSelectMode()">
             <svg class="icon" viewBox="0 0 24 24"><path d="M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12-1.42-1.41z"/></svg>é¸æŠ
        </div>

        <div class="f-btn f-select" onclick="moveItem(-1)">â¬† ç§»å‹•</div>
        <div class="f-btn f-select" onclick="moveItem(1)">â¬‡ ç§»å‹•</div>
        <div class="f-btn f-select" onclick="mergeNodes()">ğŸ”— çµåˆ</div>
        <div class="f-btn f-select" onclick="setNodeColorMenu()">ğŸ¨ è‰²</div>
        <div class="f-btn f-select" onclick="deleteItem()" style="color:var(--danger)">ğŸ—‘ å‰Šé™¤</div>
        <div class="f-btn f-select" onclick="toggleSelectMode()" style="font-weight:bold;">âœ” å®Œäº†</div>
    </div>
</div>

<script>
/* --------------------------------------------------
   ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãƒ»çŠ¶æ…‹ç®¡ç†
   -------------------------------------------------- */
const STORAGE_KEY = 'wafu_v3_projects';
let projects = [];
let currentProjectId = null;
let currentMode = 'list'; // 'list' or 'novel'
let undoStack = [];
let redoStack = [];
let uidCounter = 0;

// åˆæœŸåŒ–
window.onload = () => {
    loadProjects();
    if (projects.length === 0) createProject("æœ¬ç·¨");
    
    // URLãƒãƒƒã‚·ãƒ¥ã‚„ä¿å­˜çŠ¶æ…‹ã‹ã‚‰å¾©å¸°å¯èƒ½ãªã‚‰ã™ã‚‹ï¼ˆä»Šå›ã¯ç°¡æ˜“çš„ã«0ç•ªç›®ï¼‰
    switchProject(projects[0].id);
    
    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®æ•´ç†
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.menu-popup') && !e.target.closest('.f-btn') && !e.target.closest('.icon')) {
            document.getElementById('mainMenu').classList.remove('show');
        }
    });
};

/* --------------------------------------------------
   ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ(ã‚¿ãƒ–)ç®¡ç†
   -------------------------------------------------- */
function loadProjects() {
    try {
        const str = localStorage.getItem(STORAGE_KEY);
        if (str) projects = JSON.parse(str);
    } catch(e) { console.error(e); }
}

function saveProjects() {
    // ç¾åœ¨ã®DOMã®çŠ¶æ…‹ã‚’projectsé…åˆ—ã«åæ˜ ã—ã¦ã‹ã‚‰ä¿å­˜
    if (currentProjectId) {
        const p = projects.find(p => p.id === currentProjectId);
        if (p) {
            p.tree = serializeTree(document.getElementById('rootList'));
            p.novel = document.getElementById('novelText').value;
            p.mode = currentMode;
        }
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));
}

function createProject(name) {
    const newId = 'proj_' + Date.now();
    projects.push({
        id: newId,
        name: name,
        tree: [{text: "æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ", children:[], color:"", memo:""}],
        novel: "",
        mode: 'list'
    });
    saveProjects();
    renderTabs();
    if (projects.length === 1) switchProject(newId);
}

function addProject() {
    const name = prompt("æ–°ã—ã„ã‚¿ãƒ–ã®åå‰:", "æ–°è¦");
    if (name) createProject(name);
}

function renderTabs() {
    const bar = document.getElementById('projectBar');
    // +ãƒœã‚¿ãƒ³ä»¥å¤–ã‚’å‰Šé™¤ã—ã¦å†æç”»
    const addBtn = bar.querySelector('.p-add-btn');
    bar.innerHTML = '';
    
    projects.forEach(p => {
        const div = document.createElement('div');
        div.className = `p-tab ${p.id === currentProjectId ? 'active' : ''}`;
        div.innerText = p.name;
        div.onclick = () => switchProject(p.id);
        bar.appendChild(div);
    });
    bar.appendChild(addBtn);
}

function switchProject(id) {
    if (currentProjectId === id) return;
    // ä¿å­˜
    saveProjects();
    
    currentProjectId = id;
    const p = projects.find(p => p.id === id);
    
    // ã‚¹ã‚¿ãƒƒã‚¯ã‚¯ãƒªã‚¢
    undoStack = []; redoStack = [];
    
    // æç”»
    document.getElementById('rootList').innerHTML = '';
    buildTree(document.getElementById('rootList'), p.tree);
    document.getElementById('novelText').value = p.novel || "";
    
    setMode(p.mode || 'list');
    renderTabs();
    pushHistory(); // åˆæœŸçŠ¶æ…‹
}

function resetProject() {
    if (!confirm("ã“ã®ã‚¿ãƒ–ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    projects = projects.filter(p => p.id !== currentProjectId);
    if (projects.length === 0) createProject("æ–°è¦");
    switchProject(projects[0].id);
    saveProjects();
}

/* --------------------------------------------------
   Undo / Redo ã‚·ã‚¹ãƒ†ãƒ 
   -------------------------------------------------- */
function pushHistory() {
    // ç¾åœ¨ã®çŠ¶æ…‹(ãƒ„ãƒªãƒ¼æ§‹é€ ã¨ãƒ†ã‚­ã‚¹ãƒˆ)ã‚’ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜
    const snapshot = {
        tree: serializeTree(document.getElementById('rootList')),
        novel: document.getElementById('novelText').value,
        mode: currentMode
    };
    
    // å¤‰æ›´ãŒãªã„å ´åˆã¯è¿½åŠ ã—ãªã„ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
    if (undoStack.length > 0) {
        const last = undoStack[undoStack.length - 1];
        if (JSON.stringify(last) === JSON.stringify(snapshot)) return;
    }

    undoStack.push(snapshot);
    if (undoStack.length > 50) undoStack.shift(); // å±¥æ­´åˆ¶é™
    redoStack = []; // æ–°ã—ã„æ“ä½œã‚’ã—ãŸã‚‰Redoã¯æ¶ˆãˆã‚‹
    saveProjects(); // ã“ã“ã§æ°¸ç¶šåŒ–ã‚‚å…¼ã­ã‚‹
    updateCount();
}

function undo() {
    if (undoStack.length <= 1) return; // åˆæœŸçŠ¶æ…‹ã‚ˆã‚Šå‰ã«ã¯æˆ»ã‚Œãªã„
    redoStack.push(undoStack.pop());
    const prev = undoStack[undoStack.length - 1];
    restoreSnapshot(prev);
}

function redo() {
    if (redoStack.length === 0) return;
    const next = redoStack.pop();
    undoStack.push(next);
    restoreSnapshot(next);
}

function restoreSnapshot(snap) {
    document.getElementById('rootList').innerHTML = '';
    buildTree(document.getElementById('rootList'), snap.tree);
    document.getElementById('novelText').value = snap.novel;
    if (currentMode !== snap.mode) setMode(snap.mode);
    saveProjects();
    updateCount();
}

/* --------------------------------------------------
   ãƒãƒ¼ãƒ‰æ“ä½œãƒ»DOMæ§‹ç¯‰
   -------------------------------------------------- */
function generateId() { return 'n' + (++uidCounter); }

function addNode(text="", parentUl=null, color="", memo="") {
    const ul = parentUl || document.getElementById('rootList');
    const li = document.createElement('li');
    li.className = 'node';
    li.id = generateId();
    
    const hasMemo = memo ? 'show' : '';
    
    li.innerHTML = `
        <div class="node-box" data-color="${color}">
            <div class="node-content" onclick="handleNodeClick(this)">
                <div class="check-circle"></div>
                <div style="padding:4px; color:#ccc; cursor:grab;" ontouchstart="preventDrag(event)">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
                </div>
                <textarea class="row-text" rows="1" oninput="resize(this); updateCount()" onblur="pushHistory()">${escapeHtml(text)}</textarea>
                <div style="padding:4px; color:#ccc;" onclick="toggleMemo(this)">
                    <svg class="icon" style="width:16px;" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                </div>
            </div>
            <div class="node-memo ${hasMemo}">
                <textarea class="memo-input" placeholder="ãƒ¡ãƒ¢ãƒ»è£è¨­å®š..." oninput="pushHistory()">${escapeHtml(memo)}</textarea>
            </div>
        </div>
        <ul></ul>
    `;
    
    ul.appendChild(li);
    resize(li.querySelector('.row-text'));
    return li;
}

function preventDrag(e) { e.preventDefault(); } // ã‚¹ãƒãƒ›ã§ã®èª¤å‹•ä½œé˜²æ­¢

// ãƒ„ãƒªãƒ¼æ§‹ç¯‰
function buildTree(ul, data) {
    data.forEach(d => {
        const li = addNode(d.text, ul, d.color, d.memo);
        if (d.children) buildTree(li.querySelector('ul'), d.children);
    });
}

// ãƒ„ãƒªãƒ¼ä¿å­˜ç”¨ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
function serializeTree(ul) {
    return Array.from(ul.children).map(li => {
        const box = li.querySelector('.node-box');
        return {
            text: li.querySelector('.row-text').value,
            color: box.getAttribute('data-color') || "",
            memo: li.querySelector('.memo-input').value,
            children: serializeTree(li.querySelector('ul'))
        };
    });
}

// ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ãƒªã‚µã‚¤ã‚º
function resize(ta) {
    ta.style.height = 'auto';
    ta.style.height = ta.scrollHeight + 'px';
}

/* --------------------------------------------------
   ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ (æ§‹æˆ â‡” å°èª¬)
   -------------------------------------------------- */
function setMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.m-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(mode === 'list' ? '.m-btn:nth-child(1)' : '.m-btn:nth-child(2)').classList.add('active');
    
    const listV = document.getElementById('listView');
    const novelV = document.getElementById('novelView');
    const footer = document.querySelector('.footer');

    if (mode === 'novel') {
        // ãƒªã‚¹ãƒˆ -> å°èª¬çµåˆ
        const root = document.getElementById('rootList');
        let txt = "";
        function traverse(ul, depth) {
            Array.from(ul.children).forEach(li => {
                txt += "ã€€".repeat(depth) + li.querySelector('.row-text').value + "\n";
                traverse(li.querySelector('ul'), depth + 1);
            });
        }
        traverse(root, 0);
        document.getElementById('novelText').value = txt;
        
        listV.style.display = 'none';
        novelV.style.display = 'block';
        footer.style.display = 'none'; // å°èª¬ãƒ¢ãƒ¼ãƒ‰ã¯åŸ·ç­†é›†ä¸­
    } else {
        // å°èª¬ -> ãƒªã‚¹ãƒˆåˆ†è§£
        const text = document.getElementById('novelText').value;
        const root = document.getElementById('rootList');
        
        // æ—¢å­˜ã®æ§‹é€ ã‚’ãªã‚‹ã¹ãç¶­æŒã—ãŸã„ãŒã€ç°¡æ˜“å®Ÿè£…ã¨ã—ã¦å†æ§‹ç¯‰
        // â€»é«˜åº¦ãªç¶­æŒã‚’ã™ã‚‹ãªã‚‰DiffãŒå¿…è¦ã ãŒä»Šå›ã¯å…¨æ›¸ãæ›ãˆ
        root.innerHTML = '';
        const lines = text.split('\n');
        const stack = [{level:-1, ul:root}];
        
        lines.forEach(line => {
            if (!line.trim()) return;
            // ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆåˆ¤å®š
            const indentMatch = line.match(/^(ã€€|\t|\s)+/);
            const indentStr = indentMatch ? indentMatch[0] : "";
            // å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹=1ãƒ¬ãƒ™ãƒ«æ›ç®—
            let level = indentStr.replace(/ã€€/g, ' ').replace(/\t/g, ' ').length;
            
            // éšå±¤é£›ã³ã™ãè£œæ­£
            if (level > stack[stack.length-1].level + 1) level = stack[stack.length-1].level + 1;
            
            while(stack.length > 1 && stack[stack.length-1].level >= level) stack.pop();
            
            const li = addNode(line.trim(), stack[stack.length-1].ul);
            stack.push({level:level, ul:li.querySelector('ul')});
        });
        
        listV.style.display = 'block';
        novelV.style.display = 'none';
        footer.style.display = 'block';
    }
    updateCount();
}

/* --------------------------------------------------
   å„ç¨®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
   -------------------------------------------------- */

// --- é¸æŠãƒ¢ãƒ¼ãƒ‰ ---
function toggleSelectMode() {
    document.body.classList.toggle('select-mode');
    document.querySelectorAll('.node-box').forEach(b => b.classList.remove('selected'));
}
function handleNodeClick(content) {
    if (document.body.classList.contains('select-mode')) {
        content.parentElement.classList.toggle('selected');
        updateCount();
    }
}
function getSelectedLis() {
    return Array.from(document.querySelectorAll('.node-box.selected')).map(b => b.closest('li'));
}

// --- éšå±¤ç§»å‹• ---
function moveIndent(dir) {
    // é¸æŠãŒãªã„å ´åˆã¯ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡Œ
    const targets = getSelectedLis();
    const list = targets.length ? targets : [getFocusedLi()];
    
    list.forEach(li => {
        if(!li) return;
        if (dir === 1) { // ä¸‹ã’
            const prev = li.previousElementSibling;
            if (prev) {
                prev.querySelector('ul').appendChild(li);
                prev.querySelector('ul').style.display = 'block'; // é–‹ã
            }
        } else { // ä¸Šã’
            const parentLi = li.parentElement.closest('li');
            if (parentLi) parentLi.after(li);
        }
    });
    pushHistory();
}

function moveItem(dir) {
    const targets = getSelectedLis();
    if (!targets.length) return;
    (dir === 1 ? targets.reverse() : targets).forEach(li => {
        if (dir === -1 && li.previousElementSibling) li.parentElement.insertBefore(li, li.previousElementSibling);
        if (dir === 1 && li.nextElementSibling) li.parentElement.insertBefore(li, li.nextElementSibling.nextElementSibling);
    });
    pushHistory();
}

function deleteItem() {
    const targets = getSelectedLis();
    if (!targets.length) return;
    if (!confirm(`${targets.length}ä»¶å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    targets.forEach(li => li.remove());
    toggleSelectMode();
    pushHistory();
}

// --- çµåˆ/åˆ†å‰² (ãƒãƒ¼ã‚¸/ã‚¹ãƒ—ãƒªãƒƒãƒˆ) ---
function mergeNodes() {
    const targets = getSelectedLis();
    if (targets.length < 2) { alert("2ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„"); return; }
    
    const first = targets[0];
    let mergedText = first.querySelector('.row-text').value;
    
    for (let i = 1; i < targets.length; i++) {
        mergedText += "\n" + targets[i].querySelector('.row-text').value;
        // å­è¦ç´ ãŒã‚ã‚Œã°firstã«ç§»å‹•
        const kids = Array.from(targets[i].querySelector('ul').children);
        kids.forEach(k => first.querySelector('ul').appendChild(k));
        targets[i].remove();
    }
    first.querySelector('.row-text').value = mergedText;
    resize(first.querySelector('.row-text'));
    toggleSelectMode();
    pushHistory();
}

function splitNode(li) {
    // â€»ä»Šå›ã¯æ˜ç¤ºçš„ãªãƒœã‚¿ãƒ³ã§ã¯ãªãã€ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢å†…ã§ã®æ”¹è¡Œæ¤œçŸ¥ãªã©ã¯è¤‡é›‘ã«ãªã‚‹ãŸã‚
    // ã€Œå°èª¬ãƒ¢ãƒ¼ãƒ‰ã‚’çµŒç”±ã™ã‚‹ã€ã®ãŒä¸€ç•ªç¶ºéº—ã§ã™ãŒã€
    // è¦æœ›ã«ã‚ã‚‹ã€Œãƒãƒ¼ã‚¸â‡”ãƒãƒ©ã™ã€ã®ãƒãƒ©ã™ã¯å®Ÿè³ªã€Œå°èª¬ãƒ¢ãƒ¼ãƒ‰â†’æ§‹æˆãƒ¢ãƒ¼ãƒ‰ã€ã§å®Ÿç¾ã•ã‚Œã¦ã„ã¾ã™ã€‚
    alert("ãƒãƒ¼ãƒ‰å†…ã®æ”¹è¡Œã§åˆ†å‰²ã™ã‚‹ã«ã¯ã€ä¸€åº¦ã€Œå°èª¬ãƒ¢ãƒ¼ãƒ‰ã€ã«ã—ã¦ã‹ã‚‰æˆ»ã—ã¦ãã ã•ã„ã€‚");
}

// --- è‰²ã€ãƒ¡ãƒ¢ ---
function setNodeColorMenu() {
    const targets = getSelectedLis();
    if (!targets.length) return;
    const colors = ['red', 'blue', 'green', 'yellow', 'purple', ''];
    const c = prompt("è‰²ã‚’é¸æŠ (red, blue, green, yellow, purple, ç©ºç™½ã§è§£é™¤)", "red");
    if (colors.includes(c) || c === "") {
        targets.forEach(li => li.querySelector('.node-box').setAttribute('data-color', c));
        toggleSelectMode();
        pushHistory();
    }
}

function toggleMemo(btn) {
    const memoDiv = btn.closest('.node-box').querySelector('.node-memo');
    memoDiv.classList.toggle('show');
}

// --- æ¤œç´¢ ---
function toggleSearch() {
    const p = document.getElementById('searchPanel');
    p.classList.toggle('show');
    if (p.classList.contains('show')) document.getElementById('searchInput').focus();
}

function runSearch() {
    const q = document.getElementById('searchInput').value;
    const list = document.getElementById('searchResultList');
    list.innerHTML = '';
    if (!q) return;

    try {
        const regex = new RegExp(q);
        document.querySelectorAll('.row-text').forEach(ta => {
            if (regex.test(ta.value)) {
                const div = document.createElement('div');
                div.className = 'search-item';
                div.innerText = ta.value.substring(0, 30) + "...";
                div.onclick = () => {
                    ta.scrollIntoView({behavior:"smooth", block:"center"});
                    ta.parentElement.style.background = "#fff3b8"; // ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    setTimeout(()=>ta.parentElement.style.background="", 2000);
                    toggleSearch();
                };
                list.appendChild(div);
            }
        });
    } catch(e) { alert("æ­£è¦è¡¨ç¾ã‚¨ãƒ©ãƒ¼"); }
}

// --- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ ---
function toggleTemplate() {
    document.getElementById('tplPanel').classList.toggle('show');
    document.getElementById('mainMenu').classList.remove('show');
}
function insertTemplate(text) {
    if (currentMode === 'list') {
        const li = addNode(text, null); // æœ«å°¾ã«è¿½åŠ 
        li.scrollIntoView();
    } else {
        const ta = document.getElementById('novelText');
        const pos = ta.selectionStart;
        ta.value = ta.value.slice(0, pos) + text + ta.value.slice(pos);
    }
    toggleTemplate();
    pushHistory();
}

// --- æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ ---
function updateCount() {
    let total = 0;
    let select = 0;
    
    if (currentMode === 'novel') {
        const ta = document.getElementById('novelText');
        total = ta.value.length;
        select = ta.selectionEnd - ta.selectionStart;
    } else {
        document.querySelectorAll('.row-text').forEach(t => total += t.value.length);
        const selLis = getSelectedLis();
        selLis.forEach(li => select += li.querySelector('.row-text').value.length);
    }
    document.getElementById('countInfo').innerHTML = `å…¨: ${total}<br>é¸: ${select}`;
}

// --- å°èª¬ãƒ¢ãƒ¼ãƒ‰: ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼ãƒ“ãƒ¥ãƒ¼ ---
function handleNovelInput() {
    const ta = document.getElementById('novelText');
    updateCount();
    // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«èª¿æ•´
    // â€»textareaå†…ã®æ­£ç¢ºãªãƒ”ã‚¯ã‚»ãƒ«ä½ç½®å–å¾—ã¯é›£ã—ã„ãŒã€
    // ç°¡æ˜“çš„ã«ã€Œå…¥åŠ›ä¸­ã¯å¸¸ã«ã‚­ãƒ£ãƒ¬ãƒƒãƒˆãŒçœŸã‚“ä¸­ã«ãã‚‹ã€ã‚ˆã†ã«blur/focusã‚’ä½¿ã†æ‰‹ã‚‚ã‚ã‚‹ãŒ
    // ã‚¹ãƒãƒ›ã§ã¯ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰åˆ¶å¾¡ãŒé›£ã—ã„ãŸã‚ã€æ¨™æº–ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«ä»»ã›ã¤ã¤
    // å®šæœŸçš„ã«ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹
}
// ç°¡æ˜“ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼: é¸æŠå¤‰æ›´æ™‚ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
document.addEventListener('selectionchange', () => {
    if (currentMode === 'novel' && document.activeElement.id === 'novelText') {
        // caretã®ä½ç½®æ¨å®šã¯div mirrorç­‰ãŒå¿…è¦ã§é‡ã„ãŸã‚ã€
        // ã€Œå…¥åŠ›ã—ã¦ã„ã‚‹è¡Œã€ã¨ã„ã†ã‚ˆã‚Šã¯ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¶­æŒã‚’å„ªå…ˆ
    }
});


/* --------------------------------------------------
   ã‚¤ãƒ³ãƒãƒ¼ãƒˆ / ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
   -------------------------------------------------- */
function toggleImportExport() {
    document.getElementById('ioPanel').classList.toggle('show');
    document.getElementById('mainMenu').classList.remove('show');
}

function exportData(type) {
    let content = "";
    const root = document.getElementById('rootList');
    
    if (type === 'txt') {
        // å…¨æ–‡ãƒ†ã‚­ã‚¹ãƒˆ
        if (currentMode === 'novel') content = document.getElementById('novelText').value;
        else {
            function trav(ul, d) {
                let s = "";
                Array.from(ul.children).forEach(li => {
                    s += "ã€€".repeat(d) + li.querySelector('.row-text').value + "\n";
                    s += trav(li.querySelector('ul'), d+1);
                });
                return s;
            }
            content = trav(root, 0);
        }
    } else if (type === 'md') {
        // Markdown
        function travMd(ul, d) {
            let s = "";
            Array.from(ul.children).forEach(li => {
                s += "  ".repeat(d) + "- " + li.querySelector('.row-text').value + "\n";
                s += travMd(li.querySelector('ul'), d+1);
            });
            return s;
        }
        content = travMd(root, 0);
    } else if (type === 'opml') {
        // OPML
        content = `<?xml version="1.0"?><opml version="2.0"><head><title>Export</title></head><body>`;
        function travOpml(ul) {
            let s = "";
            Array.from(ul.children).forEach(li => {
                const txt = escapeHtml(li.querySelector('.row-text').value);
                s += `<outline text="${txt}">`;
                s += travOpml(li.querySelector('ul'));
                s += `</outline>`;
            });
            return s;
        }
        content += travOpml(root) + `</body></opml>`;
    }

    const blob = new Blob([content], {type: "text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `export.${type}`;
    a.click();
}

function importFile(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const text = e.target.result;
        // ç°¡æ˜“åˆ¤å®š
        if (text.trim().startsWith("<?xml")) {
            // OPMLãƒ‘ãƒ¼ã‚¹ã¯çœç•¥(æ­£è¦è¡¨ç¾ã§ç°¡æ˜“æŠ½å‡º)
            alert("OPMLã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯ç°¡æ˜“ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›ã•ã‚Œã¾ã™");
            const matches = text.match(/text="([^"]*)"/g);
            if(matches) {
                const extracted = matches.map(m => m.slice(6, -1)).join("\n");
                document.getElementById('novelText').value = extracted;
            }
        } else {
            // MD or TXT
            document.getElementById('novelText').value = text;
        }
        setMode('novel'); // ä¸€æ—¦å°èª¬ãƒ¢ãƒ¼ãƒ‰ã§èª­ã¿è¾¼ã‚€
        pushHistory();
        toggleImportExport();
    };
    reader.readAsText(file);
}

/* --------------------------------------------------
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   -------------------------------------------------- */
function getFocusedLi() {
    const ae = document.activeElement;
    return (ae && ae.classList.contains('row-text')) ? ae.closest('li') : null;
}
function escapeHtml(str) {
    if(!str) return "";
    return str.replace(/[&<>"']/g, function(m) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
    });
}
function toggleDark() {
    document.body.classList.toggle('dark-mode');
}
function toggleMenu() {
    document.getElementById('mainMenu').classList.toggle('show');
}

</script>
</body>
</html>
