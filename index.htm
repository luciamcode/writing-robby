<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å’Œé¢¨ åŸ·ç­†ãƒé–“ãƒ»å®Œ</title>
<style>
    :root {
        --bg-paper: #fcfaf2; --text: #2b2b2b; --bar-bg: #fdfdfd; --border: #dcd3b2;
        --accent: #165e83; --selected: #e3eff7; --danger: #b7282e;
    }
    body.dark-mode {
        --bg-paper: #202124; --text: #e8eaed; --bar-bg: #303134; --border: #5f6368;
        --accent: #8ab4f8; --selected: #3c4043; --danger: #f28b82;
    }
    body {
        font-family: "Yu Mincho", serif; background: var(--bg-paper); color: var(--text);
        margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
    }
    /* ã‚¢ã‚¤ã‚³ãƒ³(SVG) */
    .icon { width: 24px; height: 24px; fill: currentColor; vertical-align: middle; }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
        height: 50px; background: var(--bar-bg); border-bottom: 1px solid var(--border);
        display: flex; align-items: center; padding: 0 10px; justify-content: space-between;
    }
    .tabs { display: flex; background: rgba(0,0,0,0.05); border-radius: 6px; padding: 2px; }
    .tab {
        padding: 4px 12px; border: none; background: transparent; color: #888; font-size: 14px;
    }
    .tab.active { background: var(--bg-paper); color: var(--accent); font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    
    /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
    #mainArea { flex: 1; overflow: hidden; position: relative; }
    #listView { height: 100%; overflow-y: auto; padding: 10px 10px 60px 10px; }
    #novelView { height: 100%; display: none; padding: 10px; }
    #novelText { width: 100%; height: 100%; border: none; background: transparent; color: var(--text); font-size: 16px; line-height: 1.8; resize: none; outline: none; }
    
    /* ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ  */
    ul { list-style: none; padding: 0; margin: 0; }
    ul ul { padding-left: 20px; border-left: 1px dashed var(--border); margin-top: 2px; }
    .node { margin-bottom: 4px; }
    .node-content {
        display: flex; align-items: flex-start; background: var(--bar-bg);
        border: 1px solid transparent; border-radius: 4px; padding: 6px 2px;
    }
    .node-content.selected { background: var(--selected); border-color: var(--accent); }
    
    textarea.row-text {
        flex: 1; border: none; background: transparent; color: var(--text);
        font-size: 16px; line-height: 1.5; resize: none; outline: none; min-height: 24px;
        font-family: inherit;
    }
    
    /* ãƒœã‚¿ãƒ³é¡ */
    .btn-icon { padding: 8px; color: #888; cursor: pointer; display: flex; align-items: center; }
    .footer {
        height: 50px; background: var(--bar-bg); border-top: 1px solid var(--border);
        display: flex; justify-content: space-around; align-items: center;
    }
    .f-btn {
        flex: 1; height: 100%; display: flex; flex-direction: column; 
        justify-content: center; align-items: center; font-size: 10px; color: #666; border: none; background: none;
    }
    
    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .menu {
        position: absolute; top: 50px; right: 10px; width: 200px;
        background: var(--bar-bg); border: 1px solid var(--border);
        display: none; flex-direction: column; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 100;
    }
    .menu.show { display: flex; }
    .menu-item { padding: 12px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; }
    
    /* é¸æŠãƒ¢ãƒ¼ãƒ‰ */
    body.select-mode .f-normal { display: none; }
    body.select-mode .f-select { display: flex; width: 100%; background: var(--selected); }
    .f-select { display: none; }
    .check-circle { 
        width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; 
        margin-right: 8px; display: none; flex-shrink: 0; margin-top: 4px;
    }
    body.select-mode .check-circle { display: block; }
    .selected .check-circle { background: var(--accent); border-color: var(--accent); }
    
    /* ãƒ‰ãƒ©ãƒƒã‚°ç”¨ï¼ˆç°¡æ˜“ï¼‰ */
    .drag-handle { padding: 4px; color: #ccc; cursor: grab; touch-action: none; }
</style>
</head>
<body>

<div class="header">
    <div class="tabs">
        <button class="tab active" onclick="setMode('list')">æ§‹æˆ</button>
        <button class="tab" onclick="setMode('novel')">å°èª¬</button>
    </div>
    <div id="charCount" style="font-size:12px; color:#888; margin-right:10px;">0å­—</div>
    <div class="btn-icon" onclick="toggleMenu()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
    </div>
</div>

<div class="menu" id="mainMenu">
    <div class="menu-item" onclick="toggleDark()"><span>ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</span></div>
    <div class="menu-item" onclick="downloadTxt()"><span>â¬‡ ä¿å­˜(DL)</span></div>
    <div class="menu-item" onclick="importTrigger()"><span>ğŸ“‚ èª­è¾¼</span></div>
    <div class="menu-item" onclick="resetData()" style="color:var(--danger)"><span>ğŸ—‘ å…¨æ¶ˆå»</span></div>
</div>

<div id="mainArea">
    <div id="listView"><ul id="rootList"></ul></div>
    <div id="novelView"><textarea id="novelText" oninput="saveNovel()" placeholder="ã“ã“ã§æ–‡ç« ã‚’è‡ªç”±ã«ç·¨é›†..."></textarea></div>
</div>

<div class="footer">
    <div class="f-btn f-normal" onclick="moveIndent(-1)"><span>âª å­—ä¸Šã’</span></div>
    <div class="f-btn f-normal" onclick="moveIndent(1)"><span>â© å­—ä¸‹ã’</span></div>
    <div class="f-btn f-normal" onclick="addNode()" style="color:var(--accent)"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg></div>
    <div class="f-btn f-normal" onclick="toggleSelectMode()"><span>âœ… é¸æŠ</span></div>
    
    <div class="f-btn f-select" onclick="moveItem(-1)"><span>â¬† ä¸Šã¸</span></div>
    <div class="f-btn f-select" onclick="moveItem(1)"><span>â¬‡ ä¸‹ã¸</span></div>
    <div class="f-btn f-select" onclick="copyItem()"><span>ğŸ“„ è¤‡è£½</span></div>
    <div class="f-btn f-select" onclick="deleteItem()" style="color:var(--danger)"><span>ğŸ—‘ å‰Šé™¤</span></div>
    <div class="f-btn f-select" onclick="toggleSelectMode()"><span>å®Œäº†</span></div>
</div>

<input type="file" id="fileIn" style="display:none" onchange="loadFile(this)">

<script>
// â–  å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­è¾¼å‡¦ç†
const KEY = 'wafu_editor_v4';
function loadData() {
    try {
        const str = localStorage.getItem(KEY);
        if (!str) return null;
        return JSON.parse(str);
    } catch (e) {
        alert("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ãŸãŸã‚ã€ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚");
        localStorage.removeItem(KEY);
        return null;
    }
}
function saveData() {
    try {
        const data = {
            tree: serialize(document.getElementById('rootList')),
            novel: document.getElementById('novelText').value,
            mode: currMode,
            dark: document.body.classList.contains('dark-mode')
        };
        localStorage.setItem(KEY, JSON.stringify(data));
    } catch(e) { console.error("Save failed", e); }
}

// â–  ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯
let currMode = 'list';
let uid = 0;

window.onload = function() {
    const data = loadData();
    if (data) {
        if (data.dark) document.body.classList.add('dark-mode');
        buildTree(document.getElementById('rootList'), data.tree || []);
        document.getElementById('novelText').value = data.novel || "";
        if (data.mode === 'novel') setMode('novel');
    } else {
        // åˆæœŸãƒ‡ãƒ¼ã‚¿
        addNode("å’Œé¢¨åŸ·ç­†ãƒé–“ã¸ã‚ˆã†ã“ãã€‚");
        addNode("æ§‹æˆãƒ¢ãƒ¼ãƒ‰ã§è¡Œã‚’å…¥ã‚Œæ›¿ãˆã€");
        addNode("å°èª¬ãƒ¢ãƒ¼ãƒ‰ã§åŸ·ç­†ã§ãã¾ã™ã€‚");
    }
    updateCount();
};

function addNode(text="", parent=null) {
    const ul = parent || document.getElementById('rootList');
    const li = document.createElement('li');
    li.className = 'node';
    li.id = 'n' + (uid++);
    li.innerHTML = `
        <div class="node-content" onclick="onNodeClick(this)">
            <div class="check-circle"></div>
            <div class="drag-handle" ontouchstart="startDrag(event, this)">
               <svg class="icon" style="width:18px;color:#ccc" viewBox="0 0 24 24"><path d="M20 9H4v2h16V9zm0 4H4v2h16v-2z"/></svg>
            </div>
            <textarea class="row-text" rows="1" oninput="resize(this);saveData();updateCount()">${esc(text)}</textarea>
        </div>
        <ul></ul>
    `;
    ul.appendChild(li);
    const ta = li.querySelector('textarea');
    ta.value = text; 
    resize(ta);
    saveData();
    return li;
}

// â–  ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
function setMode(mode) {
    currMode = mode;
    document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
    document.querySelector(mode === 'list' ? 'button:nth-child(1)' : 'button:nth-child(2)').classList.add('active');
    
    const listDiv = document.getElementById('listView');
    const novelDiv = document.getElementById('novelView');
    const root = document.getElementById('rootList');
    const novelTa = document.getElementById('novelText');

    if (mode === 'novel') {
        // ãƒªã‚¹ãƒˆâ†’ãƒ†ã‚­ã‚¹ãƒˆçµåˆ
        let txt = "";
        function traverse(ul, depth) {
            Array.from(ul.children).forEach(li => {
                const val = li.querySelector('textarea').value;
                txt += "ã€€".repeat(depth) + val + "\n";
                traverse(li.querySelector('ul'), depth+1);
            });
        }
        traverse(root, 0);
        novelTa.value = txt;
        listDiv.style.display = 'none';
        novelDiv.style.display = 'block';
    } else {
        // ãƒ†ã‚­ã‚¹ãƒˆâ†’ãƒªã‚¹ãƒˆåˆ†è§£
        root.innerHTML = "";
        const lines = novelTa.value.split(/\n/);
        const stack = [{level:-1, ul:root}];
        lines.forEach(line => {
            if(!line.trim()) return;
            const indent = (line.match(/^(ã€€|\t|\s)+/) || [""])[0];
            let level = indent.replace(/ã€€/g,' ').replace(/\t/g,' ').length; // ç°¡æ˜“è¨ˆç®—
            // ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆæ·±ã•ãŒæ€¥ã«å¢—ãˆãŸå ´åˆã®è£œæ­£
            if (level > stack[stack.length-1].level + 1) level = stack[stack.length-1].level + 1;
            
            while(stack.length > 1 && stack[stack.length-1].level >= level) stack.pop();
            const li = addNode(line.trim(), stack[stack.length-1].ul);
            stack.push({level:level, ul:li.querySelector('ul')});
        });
        listDiv.style.display = 'block';
        novelDiv.style.display = 'none';
    }
    saveData();
}

// â–  ç°¡æ˜“ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸ä½¿ç”¨ï¼‰
let dragSrc = null;
function startDrag(e, handle) {
    // ã‚¹ãƒãƒ›ã§ã®ãƒ‰ãƒ©ãƒƒã‚°ã¯è¤‡é›‘ãªãŸã‚ã€ä»Šå›ã¯ã‚¿ãƒƒãƒ—ã§ã®ã€Œä¸Šä¸‹ç§»å‹•ã€ãƒœã‚¿ãƒ³æ¨å¥¨ã§ã™ãŒã€
    // ç°¡æ˜“çš„ã«ä¸Šä¸‹ãƒœã‚¿ãƒ³ä»£ã‚ã‚Šã¨ã—ã¦èªè­˜ã•ã›ã¾ã™
    e.preventDefault();
}

// â–  éšå±¤æ“ä½œãƒ»ç§»å‹•
function moveIndent(dir) {
    const targets = getSelected();
    if(targets.length===0) return;
    targets.forEach(li => {
        if(dir===1) { // ä¸‹ã’
            const prev = li.previousElementSibling;
            if(prev) prev.querySelector('ul').appendChild(li);
        } else { // ä¸Šã’
            const pLi = li.parentElement.closest('li');
            if(pLi) pLi.after(li);
        }
    });
    saveData();
}

function moveItem(dir) {
    const targets = getSelected();
    if(targets.length===0) return;
    (dir===1 ? targets.reverse() : targets).forEach(li => {
        if(dir===-1 && li.previousElementSibling) li.parentElement.insertBefore(li, li.previousElementSibling);
        if(dir===1 && li.nextElementSibling) li.parentElement.insertBefore(li, li.nextElementSibling.nextElementSibling);
    });
    saveData();
}

// â–  é¸æŠãƒ»ç·¨é›†
function toggleSelectMode() {
    document.body.classList.toggle('select-mode');
    document.querySelectorAll('.node-content').forEach(c=>c.classList.remove('selected'));
}
function onNodeClick(div) {
    if(document.body.classList.contains('select-mode')) {
        div.classList.toggle('selected');
    }
}
function getSelected() {
    return Array.from(document.querySelectorAll('.node-content.selected')).map(c=>c.closest('li'));
}
function deleteItem() {
    if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    getSelected().forEach(li=>li.remove());
    toggleSelectMode(); saveData();
}
function copyItem() {
    getSelected().forEach(li => {
        const clone = li.cloneNode(true);
        refreshId(clone);
        li.after(clone);
    });
    toggleSelectMode(); saveData();
}
function refreshId(li) {
    li.id = 'n'+(uid++);
    li.querySelector('textarea').value = li.querySelector('textarea').textContent; // valueå¾©å…ƒ
    li.querySelector('.node-content').classList.remove('selected');
    Array.from(li.querySelector('ul').children).forEach(refreshId);
}

// â–  ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
function resize(ta) { ta.style.height = 'auto'; ta.style.height = ta.scrollHeight + 'px'; }
function updateCount() {
    const txt = currMode==='novel' ? document.getElementById('novelText').value : 
        Array.from(document.querySelectorAll('textarea')).map(t=>t.value).join('');
    document.getElementById('charCount').innerText = txt.length + "å­—";
}
function toggleMenu() { document.getElementById('mainMenu').classList.toggle('show'); }
function toggleDark() { document.body.classList.toggle('dark-mode'); saveData(); }
function resetData() { 
    if(confirm("å…¨æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem(KEY); location.reload(); }
}
function saveNovel() { saveData(); updateCount(); }
function esc(s) { return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','':'&quot;',"'":'&#039;'}[c])); }
function serialize(ul) {
    return Array.from(ul.children).map(li => ({
        t: li.querySelector('textarea').value,
        c: serialize(li.querySelector('ul'))
    }));
}
function buildTree(ul, data) {
    data.forEach(d => {
        const li = addNode(d.t, ul);
        buildTree(li.querySelector('ul'), d.c);
    });
}

// ãƒ•ã‚¡ã‚¤ãƒ«DLãƒ»èª­è¾¼
function downloadTxt() {
    const txt = currMode==='novel' ? document.getElementById('novelText').value : 
        (function t(ul,d){return Array.from(ul.children).map(li=>"ã€€".repeat(d)+li.querySelector('textarea').value+"\n"+t(li.querySelector('ul'),d+1)).join('')})(document.getElementById('rootList'),0);
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([txt],{type:'text/plain'}));
    a.download = 'novel_draft.txt'; a.click();
}
function importTrigger() { document.getElementById('fileIn').click(); }
function loadFile(inp) {
    const f = inp.files[0]; if(!f)return;
    const r = new FileReader();
    r.onload = e => { document.getElementById('novelText').value = e.target.result; setMode('novel'); };
    r.readAsText(f);
}
</script>
</body>
</html>
