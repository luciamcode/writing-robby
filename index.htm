<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>和風 執筆ノ間・真打</title>
<style>
    :root {
        --bg-paper: #fcfaf2; --text: #2b2b2b; --bar-bg: #fdfdfd; --border: #dcd3b2;
        --accent: #165e83; --selected: #e3eff7; --danger: #b7282e; --btn-text: #666;
        --memo-bg: #f0f0e8; --highlight: #fff3b8;
        --c-red: #ffcdd2; --c-blue: #bbdefb; --c-green: #c8e6c9; --c-yellow: #fff9c4; --c-purple: #e1bee7;
    }
    body.dark-mode {
        --bg-paper: #202124; --text: #e8eaed; --bar-bg: #303134; --border: #5f6368;
        --accent: #8ab4f8; --selected: #3c4043; --danger: #f28b82; --btn-text: #aaa;
        --memo-bg: #2d2e30; --highlight: #5f6368;
        --c-red: #5c2b2b; --c-blue: #1f3a52; --c-green: #254227; --c-yellow: #4a4218; --c-purple: #3a2342;
    }
    body {
        font-family: "Yu Mincho", "Hiragino Mincho ProN", serif;
        background: var(--bg-paper); color: var(--text);
        margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
    }
    textarea, input { font-family: inherit; }
    .icon { width: 20px; height: 20px; fill: currentColor; vertical-align: middle; }

    /* --- プロジェクトタブ --- */
    .project-bar {
        height: 36px; background: var(--bar-bg); border-bottom: 1px solid var(--border);
        display: flex; overflow-x: auto; white-space: nowrap; align-items: flex-end; padding: 0 5px;
        flex-shrink: 0;
    }
    .p-tab {
        padding: 6px 12px; font-size: 13px; color: var(--btn-text); border: 1px solid transparent;
        border-bottom: none; border-radius: 6px 6px 0 0; margin-right: 2px; cursor: pointer;
    }
    .p-tab.active {
        background: var(--bg-paper); color: var(--accent); border-color: var(--border);
        font-weight: bold; position: relative; top: 1px;
    }
    .p-add-btn { padding: 6px 10px; color: var(--accent); cursor: pointer; }

    /* --- ヘッダー --- */
    .header {
        height: 44px; background: var(--bar-bg); border-bottom: 1px solid var(--border);
        display: flex; align-items: center; padding: 0 10px; justify-content: space-between;
        flex-shrink: 0; z-index: 10;
    }
    .mode-switch { display: flex; background: rgba(0,0,0,0.05); border-radius: 6px; padding: 2px; }
    .m-btn {
        padding: 4px 10px; border: none; background: transparent; color: var(--btn-text); font-size: 12px; cursor: pointer;
    }
    .m-btn.active { background: var(--bg-paper); color: var(--accent); font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .count-info { font-size: 10px; color: var(--btn-text); text-align: right; line-height: 1.2; margin-left: 10px; }
    
    /* --- メインエリア --- */
    #mainArea { flex: 1; overflow: hidden; position: relative; }
    #listView { 
        height: 100%; overflow-y: auto; padding: 10px 10px 100px 10px; 
        box-sizing: border-box; -webkit-overflow-scrolling: touch; 
    }
    #novelView { 
        height: 100%; display: none; padding: 20px 15px 100px 15px; 
        box-sizing: border-box; overflow-y: auto; 
    }
    #novelText { 
        width: 100%; min-height: 100%; border: none; background: transparent; 
        color: var(--text); font-size: 16px; line-height: 2.0; resize: none; outline: none; 
    }
    #novelText::after { content: ""; display: block; height: 50vh; }

    /* --- ノード --- */
    ul { list-style: none; padding: 0; margin: 0; }
    ul ul { padding-left: 20px; border-left: 1px dashed var(--border); margin-top: 2px; }
    .node { margin-bottom: 6px; }
    .node-box {
        background: var(--bar-bg); border: 1px solid transparent; border-radius: 4px;
        transition: background 0.2s; position: relative;
    }
    .node-content { display: flex; align-items: flex-start; padding: 6px 2px; }
    
    .node-box[data-color="red"] { background: var(--c-red); }
    .node-box[data-color="blue"] { background: var(--c-blue); }
    .node-box[data-color="green"] { background: var(--c-green); }
    .node-box[data-color="yellow"] { background: var(--c-yellow); }
    .node-box[data-color="purple"] { background: var(--c-purple); }
    .node-box.selected { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent) inset; }
    
    textarea.row-text {
        flex: 1; border: none; background: transparent; color: var(--text);
        font-size: 16px; line-height: 1.5; resize: none; outline: none; min-height: 24px;
        margin-left: 4px;
    }
    .node-memo {
        display: none; width: 100%; padding: 4px 8px; font-size: 12px; color: var(--btn-text);
        background: var(--memo-bg); border-top: 1px dashed var(--border);
        box-sizing: border-box; border-radius: 0 0 4px 4px;
    }
    .node-memo.show { display: block; }
    .memo-input { width: 100%; background: transparent; border: none; outline: none; resize: none; color: inherit; }
    mark { background: var(--highlight); color: inherit; padding: 0 2px; }

    /* --- フッター --- */
    .footer {
        position: fixed; bottom: 0; left: 0; right: 0; z-index: 20;
        background: var(--bar-bg); border-top: 1px solid var(--border);
        padding-bottom: env(safe-area-inset-bottom);
        box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    }
    .toolbar-row { height: 42px; display: flex; justify-content: space-around; align-items: center; }
    .f-btn {
        flex: 1; height: 100%; display: flex; flex-direction: column; 
        justify-content: center; align-items: center; font-size: 9px; 
        color: var(--btn-text); border: none; background: none; cursor: pointer;
    }
    .f-btn:active { background: rgba(0,0,0,0.05); }
    
    body.select-mode .f-normal { display: none; }
    body.select-mode .f-select { display: flex; }
    .f-select { display: none; }
    .check-circle { 
        width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; 
        margin-right: 4px; display: none; flex-shrink: 0; margin-top: 4px;
    }
    body.select-mode .check-circle { display: block; }
    .node-box.selected .check-circle { background: var(--accent); border-color: var(--accent); }

    /* --- パネル --- */
    .panel {
        position: fixed; top: 80px; left: 10px; right: 10px; bottom: 60px;
        background: var(--bar-bg); border: 1px solid var(--border); border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100; display: none;
        flex-direction: column;
    }
    .panel.show { display: flex; }
    .panel-header { padding: 10px; border-bottom: 1px solid var(--border); font-weight: bold; display: flex; justify-content: space-between; }
    .panel-body { flex: 1; overflow-y: auto; padding: 10px; }
    .search-item { padding: 8px; border-bottom: 1px solid var(--border); cursor: pointer; }

    /* メニューポップアップ */
    .menu-popup {
        position: absolute; top: 40px; right: 10px; width: 240px;
        background: var(--bar-bg); border: 1px solid var(--border); border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 101; display: none;
    }
    .menu-popup.show { display: block; }
    .menu-row { padding: 12px 15px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 14px; }
</style>
</head>
<body>

<div class="project-bar" id="projectBar">
    <div class="p-tab active">本編</div>
    <div class="p-add-btn" onclick="addProject()">＋</div>
</div>

<div class="header">
    <div class="mode-switch">
        <button class="m-btn active" onclick="setMode('list')">構成</button>
        <button class="m-btn" onclick="setMode('novel')">小説</button>
    </div>
    <div style="flex:1"></div>
    <div class="count-info" id="countInfo">全: 0<br>選: 0</div>
    <div class="f-btn" onclick="toggleSearch()" style="width:40px; margin-left:10px;">
        <svg class="icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
    </div>
    <div class="f-btn" onclick="toggleMenu()" style="width:40px;">
        <svg class="icon" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
    </div>
</div>

<div class="menu-popup" id="mainMenu">
    <div class="menu-row" onclick="toggleDark()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,1
