<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å’Œé¢¨ åŸ·ç­†ãƒé–“ãƒ»çœŸæ‰“</title>
<style>
    :root {
        --bg-paper: #fcfaf2; --text: #2b2b2b; --bar-bg: #fdfdfd; --border: #dcd3b2;
        --accent: #165e83; --selected: #e3eff7; --danger: #b7282e; --btn-text: #666;
        --memo-bg: #f0f0e8; --highlight: #fff3b8;
        --c-red: #ffcdd2; --c-blue: #bbdefb; --c-green: #c8e6c9; --c-yellow: #fff9c4; --c-purple: #e1bee7;
    }
    body.dark-mode {
        --bg-paper: #202124; --text: #e8eaed; --bar-bg: #303134; --border: #5f6368;
        --accent: #8ab4f8; --selected: #3c4043; --danger: #f28b82; --btn-text: #aaa;
        --memo-bg: #2d2e30; --highlight: #5f6368;
        --c-red: #5c2b2b; --c-blue: #1f3a52; --c-green: #254227; --c-yellow: #4a4218; --c-purple: #3a2342;
    }
    body {
        font-family: "Yu Mincho", "Hiragino Mincho ProN", serif;
        background: var(--bg-paper); color: var(--text);
        margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
    }
    textarea, input, select { font-family: inherit; }
    .icon { width: 20px; height: 20px; fill: currentColor; vertical-align: middle; }

    /* --- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ãƒ– --- */
    .project-bar {
        height: 36px; background: var(--bar-bg); border-bottom: 1px solid var(--border);
        display: flex; overflow-x: auto; white-space: nowrap; align-items: flex-end; padding: 0 5px; flex-shrink: 0;
    }
    .p-tab {
        padding: 6px 12px; font-size: 13px; color: var(--btn-text); border: 1px solid transparent;
        border-bottom: none; border-radius: 6px 6px 0 0; margin-right: 2px; cursor: pointer;
    }
    .p-tab.active {
        background: var(--bg-paper); color: var(--accent); border-color: var(--border);
        font-weight: bold; position: relative; top: 1px;
    }
    .p-add-btn { padding: 6px 10px; color: var(--accent); cursor: pointer; }

    /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
    .header {
        height: 44px; background: var(--bar-bg); border-bottom: 1px solid var(--border);
        display: flex; align-items: center; padding: 0 10px; justify-content: space-between;
        flex-shrink: 0; z-index: 10;
    }
    .mode-switch { display: flex; background: rgba(0,0,0,0.05); border-radius: 6px; padding: 2px; }
    .m-btn {
        padding: 4px 10px; border: none; background: transparent; color: var(--btn-text); font-size: 12px; cursor: pointer;
    }
    .m-btn.active { background: var(--bg-paper); color: var(--accent); font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .count-info { font-size: 10px; color: var(--btn-text); text-align: right; line-height: 1.2; margin-left: 10px; }
    
    /* --- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ --- */
    #mainArea { flex: 1; overflow: hidden; position: relative; }
    #listView { height: 100%; overflow-y: auto; padding: 10px 10px 100px 10px; box-sizing: border-box; -webkit-overflow-scrolling: touch; }
    #novelView { height: 100%; display: none; padding: 20px 15px 100px 15px; box-sizing: border-box; overflow-y: auto; }
    #novelText { width: 100%; min-height: 100%; border: none; background: transparent; color: var(--text); font-size: 16px; line-height: 2.0; resize: none; outline: none; }
    #novelText::after { content: ""; display: block; height: 50vh; }

    /* --- ãƒãƒ¼ãƒ‰ --- */
    ul { list-style: none; padding: 0; margin: 0; }
    ul ul { padding-left: 20px; border-left: 1px dashed var(--border); margin-top: 2px; }
    .node { margin-bottom: 6px; }
    .node.hidden { display: none; } /* æ¤œç´¢éè¡¨ç¤ºç”¨ */
    
    .node-box {
        background: var(--bar-bg); border: 1px solid transparent; border-radius: 4px;
        transition: background 0.2s; position: relative;
    }
    .node-content { display: flex; align-items: flex-start; padding: 6px 2px; }
    
    .node-box[data-color="red"] { background: var(--c-red); }
    .node-box[data-color="blue"] { background: var(--c-blue); }
    .node-box[data-color="green"] { background: var(--c-green); }
    .node-box[data-color="yellow"] { background: var(--c-yellow); }
    .node-box[data-color="purple"] { background: var(--c-purple); }
    .node-box.selected { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent) inset; }
    
    textarea.row-text {
        flex: 1; border: none; background: transparent; color: var(--text);
        font-size: 16px; line-height: 1.5; resize: none; outline: none; min-height: 24px; margin-left: 4px;
    }
    .node-memo {
        display: none; width: 100%; padding: 4px 8px; font-size: 12px; color: var(--btn-text);
        background: var(--memo-bg); border-top: 1px dashed var(--border);
        box-sizing: border-box; border-radius: 0 0 4px 4px;
    }
    .node-memo.show { display: block; }
    .memo-input { width: 100%; background: transparent; border: none; outline: none; resize: none; color: inherit; }
    mark { background: var(--highlight); color: inherit; padding: 0 2px; }

    /* --- ãƒ•ãƒƒã‚¿ãƒ¼ --- */
    .footer {
        position: fixed; bottom: 0; left: 0; right: 0; z-index: 20;
        background: var(--bar-bg); border-top: 1px solid var(--border);
        padding-bottom: env(safe-area-inset-bottom);
        box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    }
    .toolbar-row { height: 42px; display: flex; justify-content: space-around; align-items: center; }
    .f-btn {
        flex: 1; height: 100%; display: flex; flex-direction: column; 
        justify-content: center; align-items: center; font-size: 9px; 
        color: var(--btn-text); border: none; background: none; cursor: pointer;
    }
    .f-btn:active { background: rgba(0,0,0,0.05); }
    
    body.select-mode .f-normal { display: none; }
    body.select-mode .f-select { display: flex; }
    .f-select { display: none; }
    
    .check-circle { 
        width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; 
        margin-right: 4px; display: none; flex-shrink: 0; margin-top: 4px;
    }
    body.select-mode .check-circle { display: block; }
    .node-box.selected .check-circle { background: var(--accent); border-color: var(--accent); }

    /* --- ãƒ‘ãƒãƒ«å…±é€š --- */
    .panel {
        position: fixed; top: 80px; left: 10px; right: 10px; bottom: 60px;
        background: var(--bar-bg); border: 1px solid var(--border); border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100; display: none;
        flex-direction: column;
    }
    .panel.show { display: flex; }
    .panel-header { padding: 10px; border-bottom: 1px solid var(--border); font-weight: bold; display: flex; justify-content: space-between; align-items: center;}
    .panel-body { flex: 1; overflow-y: auto; padding: 10px; }
    .panel-body button { display: block; width: 100%; margin-bottom: 10px; padding: 10px; background: var(--bg-paper); border: 1px solid var(--border); color: var(--text); border-radius: 4px; text-align: center; font-weight: bold;}
    .panel-body button:active { background: var(--selected); }
    
    /* IOãƒ‘ãƒãƒ«ç”¨ */
    .io-options { margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 4px; }
    .io-label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
    .radio-group label { margin-right: 15px; font-size: 14px; cursor: pointer; }
    .btn-group { display: flex; gap: 10px; margin-bottom: 10px; }
    .btn-group button { flex: 1; margin-bottom: 0; }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    .menu-popup {
        position: absolute; top: 40px; right: 10px; width: 220px;
        background: var(--bar-bg); border: 1px solid var(--border); border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 101; display: none;
    }
    .menu-popup.show { display: block; }
    .menu-row { padding: 10px 15px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; }
    .menu-row:last-child { border-bottom: none; }
    
    .search-item { padding: 8px; border-bottom: 1px solid var(--border); cursor: pointer; }
</style>
</head>
<body>

<div class="project-bar" id="projectBar">
    <div class="p-tab active">æœ¬ç·¨</div>
    <div class="p-add-btn" onclick="addProject()">ï¼‹</div>
</div>

<div class="header">
    <div class="mode-switch">
        <button class="m-btn active" onclick="setMode('list')">æ§‹æˆ</button>
        <button class="m-btn" onclick="setMode('novel')">å°èª¬</button>
    </div>
    <div style="flex:1"></div>
    <div class="count-info" id="countInfo">å…¨: 0<br>é¸: 0</div>
    <div class="f-btn" onclick="toggleSearch()" style="width:40px; margin-left:10px;">
        <svg class="icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
    </div>
    <div class="f-btn" onclick="toggleMenu()" style="width:40px;">
        <svg class="icon" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
    </div>
</div>

<div class="menu-popup" id="mainMenu">
    <div class="menu-row" onclick="toggleDark()">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</div>
    <div class="menu-row" onclick="toggleTemplate()">ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæŒ¿å…¥</div>
    <div class="menu-row" onclick="toggleImportExport()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
        ä¿å­˜/é€£æº/èª­è¾¼
    </div>
    <div class="menu-row" onclick="resetProject()" style="color:var(--danger)">ğŸ—‘ ã‚¿ãƒ–å‰Šé™¤ãƒ»åˆæœŸåŒ–</div>
</div>

<div class="panel" id="searchPanel">
    <div class="panel-header"><span>æ¤œç´¢</span><span onclick="toggleSearch()">âœ•</span></div>
    <div style="padding:10px; border-bottom:1px solid var(--border);">
        <input type="text" id="searchInput" placeholder="æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ (æ­£è¦è¡¨ç¾å¯)" style="width:100%; padding:8px; box-sizing:border-box;">
        <div style="margin-top:5px; text-align:right;">
            <button onclick="runSearch()" style="width:auto; display:inline-block;">å®Ÿè¡Œ</button>
        </div>
    </div>
    <div class="panel-body" id="searchResultList"></div>
    <div style="padding:10px; border-top:1px solid var(--border); text-align:center;">
        <button onclick="toggleSearch(); toggleImportExport();" style="width:100%">æ¤œç´¢çµæœã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã¸</button>
    </div>
</div>

<div class="panel" id="ioPanel">
    <div class="panel-header"><span>ä¿å­˜ãƒ»é€£æºãƒ»èª­è¾¼</span><span onclick="toggleImportExport()">âœ•</span></div>
    <div class="panel-body">
        
        <div class="io-options">
            <span class="io-label">å¯¾è±¡ç¯„å›²</span>
            <div class="radio-group">
                <label><input type="radio" name="exScope" value="all" checked> å…¨ä½“</label>
                <label><input type="radio" name="exScope" value="visible"> è¡¨ç¤ºä¸­ã®ã¿</label>
                <label><input type="radio" name="exScope" value="selected"> é¸æŠä¸­ã®ã¿</label>
            </div>
            <div style="margin-top:8px;">
                <label><input type="checkbox" id="exCodeBlock"> ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ (```) ä»˜ä¸</label>
            </div>
        </div>

        <h4>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (TXTå½¢å¼)</h4>
        <div class="btn-group">
            <button onclick="copyToClipboard()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
            <button onclick="shareText()">ğŸš€ å…±æœ‰</button>
        </div>
        <button onclick="exportData('txt')">ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ (.txt)</button>
        <button onclick="exportData('md')">MDä¿å­˜ (.md)</button>
        <button onclick="exportData('opml')">OPMLä¿å­˜ (.opml)</button>

        <hr>
        <h4>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h4>
        <button onclick="importFromClipboard()">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰èª­è¾¼</button>
        <input type="file" id="fileInput" onchange="importFile(this)" style="margin-top:5px;">
    </div>
</div>

<div class="panel" id="tplPanel">
    <div class="panel-header"><span>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</span><span onclick="toggleTemplate()">âœ•</span></div>
    <div class="panel-body">
        <div class="search-item" onclick="insertTemplate('ã€ç™»å ´äººç‰©ã€‘\nãƒ»åå‰ï¼š\nãƒ»å¹´é½¢ï¼š\nãƒ»æ€§æ ¼ï¼š')">äººç‰©è¨­å®š</div>
        <div class="search-item" onclick="insertTemplate('ã€å ´é¢ã€‘\nãƒ»å ´æ‰€ï¼š\nãƒ»æ™‚é–“ï¼š\nãƒ»ç›®çš„ï¼š')">ã‚·ãƒ¼ãƒ³è¨­å®š</div>
        <div class="search-item" onclick="insertTemplate('â€¦â€¦\nã€€ã€€ã€€******\nâ€¦â€¦')">å ´é¢è»¢æ›ï¼ˆã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ï¼‰</div>
    </div>
</div>

<div id="mainArea">
    <div id="listView"><ul id="rootList"></ul></div>
    <div id="novelView"><textarea id="novelText" oninput="handleNovelInput()" onclick="handleNovelInput()"></textarea></div>
</div>

<div class="footer">
    <div class="toolbar-row">
        <div class="f-btn" onclick="undo()" style="flex:0.6"><svg class="icon" viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>æˆ»ã™</div>
        <div class="f-btn" onclick="redo()" style="flex:0.6"><svg class="icon" viewBox="0 0 24 24"><path d="M18.4 10.6C16.55 9 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg>é€²ã‚€</div>
        <div style="width:1px; background:var(--border); height:60%;"></div>
        <div class="f-btn f-normal" onclick="moveIndent(-1)"><svg class="icon" viewBox="0 0 24 24"><path d="M11 17h10v-2H11v2zm-8-5l4 4V8l-4 4zm0 9h18v-2H3v2zM3 3v2h18V3H3zm8 6h10V7H11v2zm10 4H11v-2h10v2z"/></svg>å­—ä¸Šã’</div>
        <div class="f-btn f-normal" onclick="moveIndent(1)"><svg class="icon" viewBox="0 0 24 24"><path d="M3 21h18v-2H3v2zM3 8v8l4-4-4-4zm8 9h10v-2H11v2zM3 3v2h18V3H3zm8 6h10V7H11v2zm0 4h10v-2H11v2z"/></svg>å­—ä¸‹ã’</div>
        <div class="f-btn f-normal" onclick="addNode()" style="color:var(--accent)"><svg class="icon" style="width:28px;height:28px;" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg></div>
        <div class="f-btn f-normal" onclick="toggleSelectMode()"><svg class="icon" viewBox="0 0 24 24"><path d="M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12-1.42-1.41z"/></svg>é¸æŠ</div>
        <div class="f-btn f-select" onclick="moveItem(-1)">â¬† ç§»å‹•</div>
        <div class="f-btn f-select" onclick="moveItem(1)">â¬‡ ç§»å‹•</div>
        <div class="f-btn f-select" onclick="mergeNodes()">ğŸ”— çµåˆ</div>
        <div class="f-btn f-select" onclick="setNodeColorMenu()">ğŸ¨ è‰²</div>
        <div class="f-btn f-select" onclick="deleteItem()" style="color:var(--danger)">ğŸ—‘ å‰Šé™¤</div>
        <div class="f-btn f-select" onclick="toggleSelectMode()" style="font-weight:bold;">âœ” å®Œäº†</div>
    </div>
</div>

<script>
/* === åŸºæœ¬ãƒ­ã‚¸ãƒƒã‚¯ã¯Ver.3.1ã¨åŒã˜ + æ–°æ©Ÿèƒ½ === */

const STORAGE_KEY = 'wafu_v3_projects';
let projects = [];
let currentProjectId = null;
let currentMode = 'list';
let undoStack = [], redoStack = [];
let uidCounter = 0;

window.onload = () => {
    loadProjects();
    if (projects.length === 0) createProject("æœ¬ç·¨");
    switchProject(projects[0].id);
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.menu-popup') && !e.target.closest('.f-btn') && !e.target.closest('.icon')) {
            document.getElementById('mainMenu').classList.remove('show');
        }
    });
};

/* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç† */
function loadProjects() {
    try { const str = localStorage.getItem(STORAGE_KEY); if (str) projects = JSON.parse(str); } catch(e) {}
}
function saveProjects() {
    if (currentProjectId) {
        const p = projects.find(p => p.id === currentProjectId);
        if (p) {
            p.tree = serializeTree(document.getElementById('rootList'));
            p.novel = document.getElementById('novelText').value;
            p.mode = currentMode;
        }
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));
}
function createProject(name) {
    const newId = 'proj_' + Date.now();
    projects.push({ id: newId, name: name, tree: [{text: "æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ", children:[]}], novel: "", mode: 'list' });
    saveProjects(); renderTabs();
    if (projects.length === 1) switchProject(newId);
}
function addProject() { const name = prompt("ã‚¿ãƒ–å:", "æ–°è¦"); if (name) createProject(name); }
function renderTabs() {
    const bar = document.getElementById('projectBar'); const addBtn = bar.querySelector('.p-add-btn');
    bar.innerHTML = '';
    projects.forEach(p => {
        const div = document.createElement('div'); div.className = `p-tab ${p.id === currentProjectId ? 'active' : ''}`;
        div.innerText = p.name; div.onclick = () => switchProject(p.id); bar.appendChild(div);
    });
    bar.appendChild(addBtn);
}
function switchProject(id) {
    if (currentProjectId === id) return; saveProjects();
    currentProjectId = id; const p = projects.find(p => p.id === id);
    undoStack = []; redoStack = [];
    document.getElementById('rootList').innerHTML = '';
    buildTree(document.getElementById('rootList'), p.tree);
    document.getElementById('novelText').value = p.novel || "";
    setMode(p.mode || 'list'); renderTabs(); pushHistory();
}
function resetProject() {
    if (!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    projects = projects.filter(p => p.id !== currentProjectId);
    if (projects.length === 0) createProject("æ–°è¦");
    switchProject(projects[0].id); saveProjects();
}

/* Undo/Redo */
function pushHistory() {
    const s = { tree: serializeTree(document.getElementById('rootList')), novel: document.getElementById('novelText').value, mode: currentMode };
    if (undoStack.length > 0 && JSON.stringify(undoStack[undoStack.length-1]) === JSON.stringify(s)) return;
    undoStack.push(s); if(undoStack.length>50) undoStack.shift(); redoStack=[]; saveProjects(); updateCount();
}
function undo() { if(undoStack.length<=1)return; redoStack.push(undoStack.pop()); restoreSnapshot(undoStack[undoStack.length-1]); }
function redo() { if(redoStack.length===0)return; const n=redoStack.pop(); undoStack.push(n); restoreSnapshot(n); }
function restoreSnapshot(s) {
    document.getElementById('rootList').innerHTML=''; buildTree(document.getElementById('rootList'), s.tree);
    document.getElementById('novelText').value=s.novel; if(currentMode!==s.mode) setMode(s.mode);
    saveProjects(); updateCount();
}

/* DOMæ“ä½œ */
function generateId() { return 'n' + (++uidCounter); }
function addNode(text="", parentUl=null, color="", memo="") {
    const ul = parentUl || document.getElementById('rootList');
    const li = document.createElement('li'); li.className = 'node'; li.id = generateId();
    li.innerHTML = `
        <div class="node-box" data-color="${color}">
            <div class="node-content" onclick="handleNodeClick(this)">
                <div class="check-circle"></div>
                <div style="padding:4px;color:#ccc;cursor:grab;" ontouchstart="preventDrag(event)">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
                </div>
                <textarea class="row-text" rows="1" oninput="resize(this);updateCount()" onblur="pushHistory()">${escapeHtml(text)}</textarea>
                <div style="padding:4px;color:#ccc;" onclick="toggleMemo(this)">
                    <svg class="icon" style="width:16px;" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                </div>
            </div>
            <div class="node-memo ${memo?'show':''}"><textarea class="memo-input" placeholder="ãƒ¡ãƒ¢..." oninput="pushHistory()">${escapeHtml(memo)}</textarea></div>
        </div><ul></ul>`;
    ul.appendChild(li); resize(li.querySelector('.row-text')); return li;
}
function preventDrag(e){e.preventDefault();}
function buildTree(ul, data) {
    data.forEach(d => { const li = addNode(d.text, ul, d.color, d.memo); if(d.children) buildTree(li.querySelector('ul'), d.children); });
}
function serializeTree(ul) {
    return Array.from(ul.children).map(li => ({
        text: li.querySelector('.row-text').value,
        color: li.querySelector('.node-box').getAttribute('data-color')||"",
        memo: li.querySelector('.memo-input').value,
        children: serializeTree(li.querySelector('ul'))
    }));
}
function resize(ta) { ta.style.height='auto'; ta.style.height=ta.scrollHeight+'px'; }

/* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ */
function setMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.m-btn').forEach(b=>b.classList.remove('active'));
    document.querySelector(mode==='list'?'.m-btn:nth-child(1)':'.m-btn:nth-child(2)').classList.add('active');
    const lv=document.getElementById('listView'), nv=document.getElementById('novelView'), ft=document.querySelector('.footer');
    if(mode==='novel') {
        let txt=""; function tr(ul,d){Array.from(ul.children).forEach(li=>{txt+="ã€€".repeat(d)+li.querySelector('.row-text').value+"\n";tr(li.querySelector('ul'),d+1)})}
        tr(document.getElementById('rootList'),0); document.getElementById('novelText').value=txt;
        lv.style.display='none'; nv.style.display='block'; ft.style.display='none';
    } else {
        const txt=document.getElementById('novelText').value, rt=document.getElementById('rootList'); rt.innerHTML='';
        const lines=txt.split('\n'), stack=[{l:-1,ul:rt}];
        lines.forEach(line=>{
            if(!line.trim())return; const idt=(line.match(/^(ã€€|\t|\s)+/)||[ ""])[0].replace(/ã€€/g,' ').replace(/\t/g,' ').length;
            let l=idt; if(l>stack[stack.length-1].l+1)l=stack[stack.length-1].l+1;
            while(stack.length>1 && stack[stack.length-1].l>=l)stack.pop();
            const li=addNode(line.trim(), stack[stack.length-1].ul); stack.push({l:l,ul:li.querySelector('ul')});
        });
        lv.style.display='block'; nv.style.display='none'; ft.style.display='block';
    }
    updateCount();
}

/* ãƒãƒ¼ãƒ‰æ“ä½œ */
function toggleSelectMode() { document.body.classList.toggle('select-mode'); document.querySelectorAll('.node-box').forEach(b=>b.classList.remove('selected')); }
function handleNodeClick(c) { if(document.body.classList.contains('select-mode')){ c.parentElement.classList.toggle('selected'); updateCount(); } }
function getSel() { return Array.from(document.querySelectorAll('.node-box.selected')).map(b=>b.closest('li')); }
function moveIndent(d) {
    const t=getSel().length?getSel():[getFocusedLi()];
    t.forEach(li=>{ if(!li)return; if(d===1){const p=li.previousElementSibling;if(p){p.querySelector('ul').appendChild(li);}}else{const p=li.parentElement.closest('li');if(p)p.after(li);} }); pushHistory();
}
function moveItem(d) {
    const t=getSel(); if(!t.length)return;
    (d===1?t.reverse():t).forEach(li=>{ if(d===-1&&li.previousElementSibling)li.parentElement.insertBefore(li,li.previousElementSibling); if(d===1&&li.nextElementSibling)li.parentElement.insertBefore(li,li.nextElementSibling.nextElementSibling); }); pushHistory();
}
function deleteItem() { const t=getSel(); if(!t.length||!confirm(`${t.length}ä»¶å‰Šé™¤ï¼Ÿ`))return; t.forEach(li=>li.remove()); toggleSelectMode(); pushHistory(); }
function mergeNodes() {
    const t=getSel(); if(t.length<2){alert("2ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„");return;}
    const f=t[0]; let txt=f.querySelector('.row-text').value;
    for(let i=1;i<t.length;i++){ txt+="\n"+t[i].querySelector('.row-text').value; Array.from(t[i].querySelector('ul').children).forEach(k=>f.querySelector('ul').appendChild(k)); t[i].remove(); }
    f.querySelector('.row-text').value=txt; resize(f.querySelector('.row-text')); toggleSelectMode(); pushHistory();
}
function setNodeColorMenu() {
    const t=getSel(); if(!t.length)return;
    const c=prompt("è‰²(red,blue,green,yellow,purple,ç©ºç™½):", "red");
    t.forEach(li=>li.querySelector('.node-box').setAttribute('data-color',c)); toggleSelectMode(); pushHistory();
}
function toggleMemo(b) { b.closest('.node-box').querySelector('.node-memo').classList.toggle('show'); }
function toggleSearch() { document.getElementById('searchPanel').classList.toggle('show'); if(document.getElementById('searchPanel').classList.contains('show'))document.getElementById('searchInput').focus(); }
function runSearch() {
    const q=document.getElementById('searchInput').value, lst=document.getElementById('searchResultList'); lst.innerHTML='';
    document.querySelectorAll('.node').forEach(n=>n.classList.remove('hidden')); // Reset visibility
    if(!q)return;
    
    // æ¤œç´¢å®Ÿè¡Œï¼šãƒ’ãƒƒãƒˆã—ãªã„ã‚‚ã®ã‚’hiddenã«ã™ã‚‹
    try {
        const re=new RegExp(q);
        document.querySelectorAll('.node').forEach(n => {
            const txt = n.querySelector('.row-text').value;
            if(!re.test(txt)) n.classList.add('hidden'); 
        });
        // ãƒ’ãƒƒãƒˆã—ãŸè¦ç´ ã®è¦ªã¯è¡¨ç¤ºã™ã‚‹
        document.querySelectorAll('.node:not(.hidden)').forEach(n => {
            let p = n.parentElement.closest('.node');
            while(p) { p.classList.remove('hidden'); p=p.parentElement.closest('.node'); }
        });
        // æ¤œç´¢çµæœãƒªã‚¹ãƒˆä½œæˆ
        document.querySelectorAll('.row-text').forEach(ta => {
             if(!ta.closest('.node').classList.contains('hidden')) {
                 const d=document.createElement('div'); d.className='search-item';
                 d.innerText=ta.value.substring(0,30)+"...";
                 d.onclick=()=>{ 
                     ta.scrollIntoView({behavior:"smooth",block:"center"}); 
                     ta.parentElement.style.background="#fff3b8"; setTimeout(()=>ta.parentElement.style.background="",2000); 
                     toggleSearch(); 
                 };
                 lst.appendChild(d);
             }
        });

    } catch(e){alert("æ­£è¦è¡¨ç¾ã‚¨ãƒ©ãƒ¼");}
}
function toggleTemplate() { document.getElementById('tplPanel').classList.toggle('show'); document.getElementById('mainMenu').classList.remove('show'); }
function insertTemplate(t) {
    if(currentMode==='list'){const li=addNode(t,null); li.scrollIntoView();}
    else{const ta=document.getElementById('novelText'); const p=ta.selectionStart; ta.value=ta.value.slice(0,p)+t+ta.value.slice(p);}
    toggleTemplate(); pushHistory();
}
function updateCount() {
    let t=0,s=0;
    if(currentMode==='novel'){const ta=document.getElementById('novelText'); t=ta.value.length; s=ta.selectionEnd-ta.selectionStart;}
    else{document.querySelectorAll('.row-text').forEach(x=>t+=x.value.length); getSel().forEach(li=>s+=li.querySelector('.row-text').value.length);}
    document.getElementById('countInfo').innerHTML=`å…¨:${t}<br>é¸:${s}`;
}
function handleNovelInput(){updateCount();}
function toggleDark(){document.body.classList.toggle('dark-mode');}
function toggleMenu(){document.getElementById('mainMenu').classList.toggle('show');}
function getFocusedLi(){const ae=document.activeElement; return (ae&&ae.classList.contains('row-text'))?ae.closest('li'):null;}
function escapeHtml(s){if(!s)return"";return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','':'&quot;',"'":'&#039;'}[c]));}

/* =========================================================
   ä¿å­˜ãƒ»é€£æºãƒ»èª­è¾¼æ©Ÿèƒ½ (å¼·åŒ–ç‰ˆ)
   ========================================================= */
function toggleImportExport() {
    document.getElementById('ioPanel').classList.toggle('show');
    document.getElementById('mainMenu').classList.remove('show');
}

// ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getExportContent() {
    const scope = document.querySelector('input[name="exScope"]:checked').value;
    const isCode = document.getElementById('exCodeBlock').checked;
    let content = "";

    if (currentMode === 'novel') {
        content = document.getElementById('novelText').value;
    } else {
        const root = document.getElementById('rootList');
        
        function traverse(ul, depth) {
            let s = "";
            Array.from(ul.children).forEach(li => {
                // Scopeåˆ¤å®š
                if (scope === 'visible' && (li.classList.contains('hidden') || li.offsetParent === null)) return;
                if (scope === 'selected' && !li.querySelector('.node-box').classList.contains('selected')) {
                    // å­ã ã‘ãƒã‚§ãƒƒã‚¯ã™ã‚‹å†å¸°ã‚‚è€ƒãˆã‚‰ã‚Œã‚‹ãŒã€å˜ç´”åŒ–ã®ãŸã‚ã€Œéé¸æŠã€ã¯ã‚¹ã‚­ãƒƒãƒ—
                    // ãŸã ã—ã€å­ã«é¸æŠæ¸ˆã¿ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„â€¦ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œé¸æŠã—ãŸãƒãƒ¼ãƒ‰ã¨ãã®å­ã€ã‚’å‡ºåŠ›
                    // ã¨ã„ã†ã‚ˆã‚Šã€Œé¸æŠã•ã‚ŒãŸè¡Œãã®ã‚‚ã®ã€ã ã‘ã‚’å‡ºã™ã‹ã€éšå±¤ã‚’ç¶­æŒã™ã‚‹ã‹ã€‚
                    // ã“ã“ã§ã¯ã€Œé¸æŠã•ã‚Œã¦ã„ãªã„ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—ã€ã¨ã—ã¾ã™ã€‚
                     return;
                }
                
                s += "ã€€".repeat(depth) + li.querySelector('.row-text').value + "\n";
                // å­è¦ç´ ã®æ¢ç´¢
                // selectedãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€å­ãŒæœªé¸æŠãªã‚‰å‡ºã•ãªã„ã®ã‹ã€è¦ªãŒé¸æŠãªã‚‰å…¨éƒ¨å‡ºã™ã®ã‹ï¼Ÿ
                // è¦ªãŒé¸æŠãªã‚‰å­ã¯å…¨éƒ¨å‡ºã™ã€ã¨ã„ã†æŒ™å‹•ãŒè‡ªç„¶ãªã“ã¨ãŒå¤šã„ã§ã™ãŒã€
                // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã€Œé¸æŠã®ã¿ã€ã«å¾“ã„å³å¯†ã«ã—ã¾ã™ã€‚
                // â˜…ä¿®æ­£: è¦ªãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°å­ã¯è‡ªå‹•çš„ã«å‡ºã™ã€ãªã©ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã¨ä¾¿åˆ©ã§ã™ãŒ
                // ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œå†å¸°ã€ã—ã¾ã™ã€‚
                s += traverse(li.querySelector('ul'), depth + 1);
            });
            return s;
        }

        // Scope: Visibleã®å ´åˆã¯DOMã®çŠ¶æ…‹ã‚’è¦‹ã‚‹
        // Scope: Selectedã®å ´åˆã¯ã‚¯ãƒ©ã‚¹ã‚’è¦‹ã‚‹
        if (scope === 'selected') {
            // Selectedã¯ãƒ•ãƒ©ãƒƒãƒˆã«ä¸¦ã¹ã‚‹ã‹ã€éšå±¤ç¶­æŒã‹ã€‚éšå±¤ç¶­æŒã¯é›£ã—ã„ã®ã§ã€
            // é¸æŠã•ã‚ŒãŸLIã‚’é †ç•ªã«æ‹¾ã†ã ã‘ã«ã—ã¾ã™ã€‚
            const sel = getSel(); // å–å¾—æ¸ˆã¿LIé…åˆ—
            if(sel.length === 0) { alert("é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“"); return ""; }
            sel.forEach(li => {
                 content += li.querySelector('.row-text').value + "\n";
            });
        } else {
            content = traverse(root, 0);
        }
    }

    if (isCode) content = "```\n" + content + "\n```";
    return content;
}

// --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---

// 1. ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
function copyToClipboard() {
    const text = getExportContent();
    if (!text) return;
    navigator.clipboard.writeText(text).then(() => {
        alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
        toggleImportExport();
    }).catch(err => alert("ã‚³ãƒ”ãƒ¼å¤±æ•—: " + err));
}

// 2. å…±æœ‰ (Web Share API)
function shareText() {
    const text = getExportContent();
    if (!text) return;
    if (navigator.share) {
        navigator.share({
            title: 'åŸ·ç­†ãƒé–“ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ',
            text: text
        }).catch(console.error);
    } else {
        alert("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å…±æœ‰æ©Ÿèƒ½ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚\nã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚");
    }
}

// 3. ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜
function exportData(type) {
    let content = getExportContent(); // åŸºæœ¬ãƒ†ã‚­ã‚¹ãƒˆ
    if(!content && type !=='opml') return; // OPMLã¯åˆ¥ç”Ÿæˆ

    if (type === 'md') {
        // MDå¤‰æ› (ç°¡æ˜“: ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’ - ã«)
        const lines = content.split('\n');
        content = lines.map(l => {
            const match = l.match(/^(ã€€+)(.*)/);
            if(match) {
                const depth = match[1].length;
                return "  ".repeat(depth) + "- " + match[2];
            }
            return l ? "- " + l : "";
        }).join('\n');
    } 
    else if (type === 'opml') {
        // OPMLã¯æ§‹é€ ãŒå¿…è¦ãªã®ã§ã€getExportContentã®çµæœã§ã¯ãªãã€ãƒ„ãƒªãƒ¼ã‹ã‚‰ç”Ÿæˆã—ãªãŠã™å¿…è¦ãŒã‚ã‚‹
        // Scopeã‚’é©ç”¨ã™ã‚‹ã®ã¯å¤§å¤‰ãªã®ã§ã€OPMLã¯ã€Œå…¨ä½“ã€ã®ã¿ã¨ã—ã¾ã™ï¼ˆã¾ãŸã¯è­¦å‘Šï¼‰
        content = `<?xml version="1.0"?><opml version="2.0"><head><title>Export</title></head><body>`;
        function travOpml(ul) {
            let s = "";
            Array.from(ul.children).forEach(li => {
                if(li.classList.contains('hidden')) return; // ç°¡æ˜“Visibleå¯¾å¿œ
                const txt = escapeHtml(li.querySelector('.row-text').value);
                s += `<outline text="${txt}">`;
                s += travOpml(li.querySelector('ul'));
                s += `</outline>`;
            });
            return s;
        }
        content += travOpml(document.getElementById('rootList')) + `</body></opml>`;
    }

    const blob = new Blob([content], {type: "text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `export.${type}`;
    a.click();
}

// 4. ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
function importFromClipboard() {
    navigator.clipboard.readText().then(text => {
        if (!text) { alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¯ç©ºã§ã™"); return; }
        document.getElementById('novelText').value = text;
        setMode('novel'); 
        alert("è²¼ã‚Šä»˜ã‘ã¾ã—ãŸã€‚å¿…è¦ãªã‚‰æ§‹æˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„ã€‚");
        toggleImportExport();
    }).catch(err => {
        alert("èª­ã¿è¾¼ã¿å¤±æ•—: " + err + "\nãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨©é™è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    });
}

function importFile(input) {
    const file = input.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const text = e.target.result;
        if (text.trim().startsWith("<?xml") || text.includes("<opml")) {
             try {
                const items = parseOpml(text);
                document.getElementById('rootList').innerHTML = "";
                buildTree(document.getElementById('rootList'), items);
                currentMode = 'list';
                document.querySelector('.m-btn:nth-child(1)').click();
             } catch(e) { alert("OPMLã‚¨ãƒ©ãƒ¼"); }
        } else {
            const cleanText = text.replace(/^(\s*)[-*+]\s+/gm, (match, p1) => p1 + ""); 
            document.getElementById('novelText').value = cleanText;
            setMode('novel'); setMode('list'); 
        }
        pushHistory(); toggleImportExport();
    };
    reader.readAsText(file);
}

function parseOpml(xmlStr) {
    const parser = new DOMParser();
    const xml = parser.parseFromString(xmlStr, "text/xml");
    function walk(node) {
        const children = [];
        Array.from(node.children).forEach(child => {
            if(child.tagName === 'outline') {
                children.push({ text: child.getAttribute('text') || child.getAttribute('title') || "", children: walk(child) });
            }
        });
        return children;
    }
    return walk(xml.querySelector('body'));
}

</script>
</body>
</html>
