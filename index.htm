<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
<title>å’Œé¢¨ åŸ·ç­†ãƒé–“</title>
<style>
    :root {
        --bg-paper: #fcfaf2; --text: #2b2b2b; --bar-bg: #fdfdfd; --border: #dcd3b2;
        --accent: #165e83; --selected: #e3eff7; --danger: #b7282e; --btn-text: #666;
        --memo-bg: #f0f0e8; --highlight: #fff3b8;
        --c-red: #ffcdd2; --c-blue: #bbdefb; --c-green: #c8e6c9; --c-yellow: #fff9c4; --c-purple: #e1bee7;
        
        --h-proj: 36px;
        --h-head: 44px;
        --h-foot: 50px;
    }
    body.dark-mode {
        --bg-paper: #202124; --text: #e8eaed; --bar-bg: #303134; --border: #5f6368;
        --accent: #8ab4f8; --selected: #3c4043; --danger: #f28b82; --btn-text: #aaa;
        --memo-bg: #2d2e30; --highlight: #5f6368;
        --c-red: #5c2b2b; --c-blue: #1f3a52; --c-green: #254227; --c-yellow: #4a4218; --c-purple: #3a2342;
    }
    
    html { height: 100%; overflow: hidden; }
    body {
        font-family: "Yu Mincho", "Hiragino Mincho ProN", serif;
        background: var(--bg-paper); color: var(--text);
        margin: 0; padding: 0; width: 100%; 
        height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
    }
    
    textarea, input, select { font-family: inherit; }
    .icon { width: 20px; height: 20px; fill: currentColor; vertical-align: middle; }

    /* 1. ä¸Šéƒ¨ã‚¨ãƒªã‚¢ */
    .top-area { flex: 0 0 auto; z-index: 10; background: var(--bar-bg); border-bottom: 1px solid var(--border); width: 100%; }

    .project-bar {
        height: var(--h-proj); display: flex; overflow-x: auto; white-space: nowrap; align-items: flex-end; padding: 0 5px; border-bottom: 1px solid var(--border);
    }
    .p-tab {
        padding: 6px 12px; font-size: 13px; color: var(--btn-text); border: 1px solid transparent;
        border-bottom: none; border-radius: 6px 6px 0 0; margin-right: 2px; cursor: pointer;
    }
    .p-tab.active {
        background: var(--bg-paper); color: var(--accent); border-color: var(--border);
        font-weight: bold; position: relative; top: 1px;
    }
    .p-add-btn { padding: 6px 10px; color: var(--accent); cursor: pointer; }

    .header {
        height: var(--h-head); display: flex; align-items: center; padding: 0 10px; justify-content: space-between;
    }
    .mode-switch { display: flex; background: rgba(0,0,0,0.05); border-radius: 6px; padding: 2px; }
    .m-btn {
        padding: 4px 10px; border: none; background: transparent; color: var(--btn-text); font-size: 12px; cursor: pointer;
    }
    .m-btn.active { background: var(--bg-paper); color: var(--accent); font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .count-info { font-size: 10px; color: var(--btn-text); text-align: right; line-height: 1.2; margin-left: 10px; }

    /* 2. ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
    #mainArea {
        flex: 1 1 auto; overflow: hidden; position: relative; display: flex; flex-direction: column; width: 100%;
    }
    #listView, #novelView {
        flex: 1; overflow-y: auto; padding: 10px; -webkit-overflow-scrolling: touch; box-sizing: border-box;
    }
    #novelView { padding: 15px; }
    #novelText { 
        width: 100%; height: 100%; border: none; background: transparent; 
        color: var(--text); font-size: 16px; line-height: 2.0; resize: none; outline: none; 
    }
    #novelText::after, #listView::after { content: ""; display: block; height: 100px; }

    /* 3. ãƒ•ãƒƒã‚¿ãƒ¼ */
    .footer {
        flex: 0 0 auto; z-index: 10; width: 100%;
        background: var(--bar-bg); border-top: 1px solid var(--border);
        padding-bottom: env(safe-area-inset-bottom);
        min-height: var(--h-foot);
    }
    .toolbar-row { height: var(--h-foot); display: flex; justify-content: space-around; align-items: center; width: 100%; }
    .f-btn {
        flex: 1; height: 100%; display: flex; flex-direction: column; 
        justify-content: center; align-items: center; font-size: 9px; 
        color: var(--btn-text); border: none; background: none; cursor: pointer;
    }
    .f-btn:active { background: rgba(0,0,0,0.05); }

    /* ãƒ©ãƒ”ãƒƒãƒ‰ãƒãƒ¼ (ä¿®æ­£ç‰ˆ) */
    #rapidBar {
        display: none; height: var(--h-foot); align-items: center; 
        padding: 0 10px; box-sizing: border-box; background: var(--bar-bg);
        width: 100%; /* æ¨ªå¹…ã„ã£ã±ã„ã«ã™ã‚‹ */
    }
    .rapid-input {
        flex: 1; height: 36px; border-radius: 18px; border: 1px solid var(--border); 
        background: var(--bg-paper); color: var(--text); padding: 0 15px; outline: none; margin-right: 8px; font-size: 16px;
    }
    .rapid-send {
        width: 36px; height: 36px; border-radius: 50%; background: var(--accent); color: #fff;
        border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
    }
    .rapid-close {
        width: 36px; height: 36px; background: transparent; color: var(--btn-text); border: none; 
        font-size: 24px; cursor: pointer; margin-left: 2px; flex-shrink: 0; display: flex; align-items: center; justify-content: center;
    }

    /* ãƒãƒ¼ãƒ‰ */
    ul { list-style: none; padding: 0; margin: 0; }
    ul ul { padding-left: 20px; border-left: 1px dashed var(--border); margin-top: 2px; }
    .node { margin-bottom: 6px; }
    .node.hidden { display: none; }
    .node-box {
        background: var(--bar-bg); border: 1px solid transparent; border-radius: 4px;
        transition: background 0.2s; position: relative;
    }
    .node-content { display: flex; align-items: flex-start; padding: 6px 2px; }
    .node-box[data-color="red"] { background: var(--c-red); }
    .node-box[data-color="blue"] { background: var(--c-blue); }
    .node-box[data-color="green"] { background: var(--c-green); }
    .node-box[data-color="yellow"] { background: var(--c-yellow); }
    .node-box[data-color="purple"] { background: var(--c-purple); }
    .node-box.selected { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent) inset; }
    
    textarea.row-text {
        flex: 1; border: none; background: transparent; color: var(--text);
        font-size: 16px; line-height: 1.5; resize: none; outline: none; min-height: 24px; margin-left: 4px;
    }
    .node-memo {
        display: none; width: 100%; padding: 4px 8px; font-size: 12px; color: var(--btn-text);
        background: var(--memo-bg); border-top: 1px dashed var(--border);
        box-sizing: border-box; border-radius: 0 0 4px 4px;
    }
    .node-memo.show { display: block; }
    .memo-input { width: 100%; background: transparent; border: none; outline: none; resize: none; color: inherit; }
    
    body.select-mode .f-normal { display: none; }
    body.select-mode .f-select { display: flex; }
    .f-select { display: none; }
    
    body.rapid-mode .toolbar-row { display: none; }
    body.rapid-mode #rapidBar { display: flex; }
    
    .check-circle { 
        width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; 
        margin-right: 4px; display: none; flex-shrink: 0; margin-top: 4px;
    }
    body.select-mode .check-circle { display: block; }
    .node-box.selected .check-circle { background: var(--accent); border-color: var(--accent); }

    .panel {
        position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
        background: var(--bar-bg); border: 1px solid var(--border); border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100; display: none; flex-direction: column;
    }
    .panel.show { display: flex; }
    .panel-header { padding: 10px; border-bottom: 1px solid var(--border); font-weight: bold; display: flex; justify-content: space-between; align-items: center;}
    .panel-body { flex: 1; overflow-y: auto; padding: 10px; }
    .panel-body button { display: block; width: 100%; margin-bottom: 10px; padding: 10px; background: var(--bg-paper); border: 1px solid var(--border); color: var(--text); border-radius: 4px; text-align: center; font-weight: bold;}
    
    .io-options { margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 4px; }
    .radio-group label { margin-right: 15px; font-size: 14px; cursor: pointer; }
    .btn-group { display: flex; gap: 10px; margin-bottom: 10px; }
    .btn-group button { flex: 1; margin-bottom: 0; }

    .menu-popup {
        position: absolute; top: 40px; right: 10px; width: 220px;
        background: var(--bar-bg); border: 1px solid var(--border); border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 101; display: none;
    }
    .menu-popup.show { display: block; }
    .menu-row { padding: 10px 15px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; }
    .search-item { padding: 8px; border-bottom: 1px solid var(--border); cursor: pointer; }
</style>
</head>
<body>

<div class="top-area">
    <div class="project-bar" id="projectBar">
        <div class="p-tab active">æœ¬ç·¨</div>
        <div class="p-add-btn" onclick="addProject()">ï¼‹</div>
    </div>
    <div class="header">
        <div class="mode-switch">
            <button class="m-btn active" onclick="setMode('list')">æ§‹æˆ</button>
            <button class="m-btn" onclick="setMode('novel')">å°èª¬</button>
        </div>
        <div style="flex:1"></div>
        <div class="count-info" id="countInfo">å…¨: 0<br>é¸: 0</div>
        <div class="f-btn" onclick="toggleSearch()" style="width:40px; margin-left:10px;">
            <svg class="icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        </div>
        <div class="f-btn" onclick="toggleMenu()" style="width:40px;">
            <svg class="icon" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
        </div>
    </div>
</div>

<div id="mainArea">
    <div id="listView"><ul id="rootList"></ul></div>
    <div id="novelView"><textarea id="novelText" oninput="handleNovelInput()" onclick="handleNovelInput()"></textarea></div>
    
    <div class="panel" id="searchPanel">
        <div class="panel-header"><span>æ¤œç´¢</span><span onclick="toggleSearch()">âœ•</span></div>
        <div style="padding:10px; border-bottom:1px solid var(--border);">
            <input type="text" id="searchInput" placeholder="æ­£è¦è¡¨ç¾å¯" style="width:100%; padding:8px;">
            <div style="margin-top:5px; text-align:right;"><button onclick="runSearch()" style="width:auto; display:inline-block;">å®Ÿè¡Œ</button></div>
        </div>
        <div class="panel-body" id="searchResultList"></div>
        <div style="padding:10px; text-align:center;"><button onclick="toggleSearch(); toggleImportExport();">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã¸</button></div>
    </div>

    <div class="panel" id="ioPanel">
        <div class="panel-header"><span>ä¿å­˜ãƒ»é€£æº</span><span onclick="toggleImportExport()">âœ•</span></div>
        <div class="panel-body">
            <div class="io-options">
                <div class="radio-group">
                    <label><input type="radio" name="exScope" value="all" checked> å…¨ä½“</label>
                    <label><input type="radio" name="exScope" value="visible"> è¡¨ç¤ºã®ã¿</label>
                    <label><input type="radio" name="exScope" value="selected"> é¸æŠã®ã¿</label>
                </div>
                <div style="margin-top:8px;"><label><input type="checkbox" id="exCodeBlock"> ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯(```)</label></div>
            </div>
            <div class="btn-group">
                <button onclick="copyToClipboard()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                <button onclick="shareText()">ğŸš€ å…±æœ‰</button>
            </div>
            <button onclick="exportData('txt')">ğŸ’¾ TXTä¿å­˜</button>
            <button onclick="exportData('md')">MDä¿å­˜</button>
            <button onclick="exportData('opml')">OPMLä¿å­˜</button>
            <hr>
            <button onclick="importFromClipboard()">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰èª­è¾¼</button>
            <input type="file" id="fileInput" onchange="importFile(this)" style="margin-top:5px;">
        </div>
    </div>

    <div class="panel" id="tplPanel">
        <div class="panel-header"><span>å®šå‹æ–‡</span><span onclick="toggleTemplate()">âœ•</span></div>
        <div class="panel-body">
            <div class="search-item" onclick="insertTemplate('ã€ç™»å ´äººç‰©ã€‘\nãƒ»åå‰ï¼š\nãƒ»å¹´é½¢ï¼š\nãƒ»æ€§æ ¼ï¼š')">äººç‰©è¨­å®š</div>
            <div class="search-item" onclick="insertTemplate('ã€å ´é¢ã€‘\nãƒ»å ´æ‰€ï¼š\nãƒ»æ™‚é–“ï¼š\nãƒ»ç›®çš„ï¼š')">ã‚·ãƒ¼ãƒ³è¨­å®š</div>
            <div class="search-item" onclick="insertTemplate('\nâ€¦â€¦\nã€€ã€€ã€€******\nâ€¦â€¦\n')">å ´é¢è»¢æ›</div>
            <div class="search-item" onclick="insertTemplate('ã€Œã€')">ã‚«ã‚®ã‚«ãƒƒã‚³</div>
        </div>
    </div>
</div>

<div class="footer">
    <div class="toolbar-row">
        <div class="f-btn" onclick="undo()" style="flex:0.6"><svg class="icon" viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>æˆ»ã™</div>
        <div class="f-btn" onclick="redo()" style="flex:0.6"><svg class="icon" viewBox="0 0 24 24"><path d="M18.4 10.6C16.55 9 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg>é€²ã‚€</div>
        <div style="width:1px; background:var(--border); height:60%;"></div>
        <div class="f-btn f-normal" onclick="moveIndent(-1)"><svg class="icon" viewBox="0 0 24 24"><path d="M11 17h10v-2H11v2zm-8-5l4 4V8l-4 4zm0 9h18v-2H3v2zM3 3v2h18V3H3zm8 6h10V7H11v2zm10 4H11v-2h10v2z"/></svg>å­—ä¸Šã’</div>
        <div class="f-btn f-normal" onclick="moveIndent(1)"><svg class="icon" viewBox="0 0 24 24"><path d="M3 21h18v-2H3v2zM3 8v8l4-4-4-4zm8 9h10v-2H11v2zM3 3v2h18V3H3zm8 6h10V7H11v2zm0 4h10v-2H11v2z"/></svg>å­—ä¸‹ã’</div>
        <div class="f-btn f-normal" onclick="addNode()" style="color:var(--accent)"><svg class="icon" style="width:28px;height:28px;" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg></div>
        <div class="f-btn f-normal" onclick="toggleSelectMode()"><svg class="icon" viewBox="0 0 24 24"><path d="M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12-1.42-1.41z"/></svg>é¸æŠ</div>
        
        <div class="f-btn f-select" onclick="moveItem(-1)">â¬† ç§»å‹•</div>
        <div class="f-btn f-select" onclick="moveItem(1)">â¬‡ ç§»å‹•</div>
        <div class="f-btn f-select" onclick="mergeNodes()">ğŸ”— çµåˆ</div>
        <div class="f-btn f-select" onclick="setNodeColorMenu()">ğŸ¨ è‰²</div>
        <div class="f-btn f-select" onclick="deleteItem()" style="color:var(--danger)">ğŸ—‘ å‰Šé™¤</div>
        <div class="f-btn f-select" onclick="toggleSelectMode()" style="font-weight:bold;">âœ” å®Œäº†</div>
    </div>
    
    <div id="rapidBar">
        <input type="text" id="rapidInput" class="rapid-input" placeholder="Rapid Fire Mode..." onkeydown="checkRapidEnter(event)">
        <button class="rapid-send" onclick="submitRapid()">
            <svg class="icon" style="width:20px;height:20px;" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
        <button class="rapid-close" onclick="toggleRapidMode()">Ã—</button>
    </div>
</div>

<div class="menu-popup" id="mainMenu">
    <div class="menu-row" onclick="toggleRapidMode()">âš¡ ãƒ©ãƒ”ãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</div>
    <div class="menu-row" onclick="toggleDark()">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</div>
    <div class="menu-row" onclick="toggleTemplate()">ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæŒ¿å…¥</div>
    <div class="menu-row" onclick="toggleImportExport()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
        ä¿å­˜/é€£æº/èª­è¾¼
    </div>
    <div class="menu-row" onclick="resetProject()" style="color:var(--danger)">ğŸ—‘ ã‚¿ãƒ–å‰Šé™¤ãƒ»åˆæœŸåŒ–</div>
</div>

<script>
const STORAGE_KEY = 'wafu_v3_6';
let projects = [], currentProjectId = null, currentMode = 'list';
let undoStack = [], redoStack = [], uidCounter = 0;

window.onload = () => {
    loadProjects();
    if (projects.length === 0) createProject("æœ¬ç·¨");
    switchProject(projects[0].id);
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.menu-popup') && !e.target.closest('.f-btn') && !e.target.closest('.icon')) {
            document.getElementById('mainMenu').classList.remove('show');
        }
    });
};

function loadProjects() { try { const str = localStorage.getItem(STORAGE_KEY); if (str) projects = JSON.parse(str); } catch(e) {} }
function saveProjects() {
    if (currentProjectId) {
        const p = projects.find(p => p.id === currentProjectId);
        if (p) {
            p.tree = serializeTree(document.getElementById('rootList'));
            p.novel = document.getElementById('novelText').value;
            p.mode = currentMode;
        }
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));
}
function createProject(name) {
    const newId = 'proj_' + Date.now();
    projects.push({ id: newId, name: name, tree: [{text: "æ–°è¦", children:[]}], novel: "", mode: 'list' });
    saveProjects(); renderTabs();
    if (projects.length === 1) switchProject(newId);
}
function addProject() { const name = prompt("ã‚¿ãƒ–å:", "æ–°è¦"); if (name) createProject(name); }
function renderTabs() {
    const bar = document.getElementById('projectBar'); const addBtn = bar.querySelector('.p-add-btn');
    bar.innerHTML = '';
    projects.forEach(p => {
        const div = document.createElement('div'); div.className = `p-tab ${p.id === currentProjectId ? 'active' : ''}`;
        div.innerText = p.name; div.onclick = () => switchProject(p.id); bar.appendChild(div);
    });
    bar.appendChild(addBtn);
}
function switchProject(id) {
    if (currentProjectId === id) return; saveProjects();
    currentProjectId = id; const p = projects.find(p => p.id === id);
    undoStack = []; redoStack = [];
    document.getElementById('rootList').innerHTML = '';
    buildTree(document.getElementById('rootList'), p.tree);
    document.getElementById('novelText').value = p.novel || "";
    setMode(p.mode || 'list'); renderTabs(); pushHistory();
}
function resetProject() {
    if (!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    projects = projects.filter(p => p.id !== currentProjectId);
    if (projects.length === 0) createProject("æ–°è¦");
    switchProject(projects[0].id); saveProjects();
}

function pushHistory() {
    const s = { tree: serializeTree(document.getElementById('rootList')), novel: document.getElementById('novelText').value, mode: currentMode };
    if (undoStack.length > 0 && JSON.stringify(undoStack[undoStack.length-1]) === JSON.stringify(s)) return;
    undoStack.push(s); if(undoStack.length>50) undoStack.shift(); redoStack=[]; saveProjects(); updateCount();
}
function undo() { if(undoStack.length<=1)return; redoStack.push(undoStack.pop()); restoreSnapshot(undoStack[undoStack.length-1]); }
function redo() { if(redoStack.length===0)return; const n=redoStack.pop(); undoStack.push(n); restoreSnapshot(n); }
function restoreSnapshot(s) {
    document.getElementById('rootList').innerHTML=''; buildTree(document.getElementById('rootList'), s.tree);
    document.getElementById('novelText').value=s.novel; if(currentMode!==s.mode) setMode(s.mode);
    saveProjects(); updateCount();
}

function generateId() { return 'n' + (++uidCounter); }
function addNode(text="", parentUl=null, color="", memo="") {
    const ul = parentUl || document.getElementById('rootList');
    const li = document.createElement('li'); li.className = 'node'; li.id = generateId();
    li.innerHTML = `
        <div class="node-box" data-color="${color}">
            <div class="node-content" onclick="handleNodeClick(this)">
                <div class="check-circle"></div>
                <div style="padding:4px;color:#ccc;cursor:grab;" ontouchstart="preventDrag(event)">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
                </div>
                <textarea class="row-text" rows="1" oninput="resize(this);updateCount()" onblur="pushHistory()">${escapeHtml(text)}</textarea>
                <div style="padding:4px;color:#ccc;" onclick="toggleMemo(this)">
                    <svg class="icon" style="width:16px;" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                </div>
            </div>
            <div class="node-memo ${memo?'show':''}"><textarea class="memo-input" placeholder="ãƒ¡ãƒ¢..." oninput="pushHistory()">${escapeHtml(memo)}</textarea></div>
        </div><ul></ul>`;
    ul.appendChild(li); resize(li.querySelector('.row-text')); return li;
}
function preventDrag(e){e.preventDefault();}
function buildTree(ul, data) { data.forEach(d => { const li = addNode(d.text, ul, d.color, d.memo); if(d.children) buildTree(li.querySelector('ul'), d.children); }); }
function serializeTree(ul) {
    return Array.from(ul.children).map(li => ({
        text: li.querySelector('.row-text').value,
        color: li.querySelector('.node-box').getAttribute('data-color')||"",
        memo: li.querySelector('.memo-input').value,
        children: serializeTree(li.querySelector('ul'))
    }));
}
function resize(ta) { ta.style.height='auto'; ta.style.height=ta.scrollHeight+'px'; }

function setMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.m-btn').forEach(b=>b.classList.remove('active'));
    document.querySelector(mode==='list'?'.m-btn:nth-child(1)':'.m-btn:nth-child(2)').classList.add('active');
    const lv=document.getElementById('listView'), nv=document.getElementById('novelView');
    const ft=document.querySelector('.footer');
    
    // ãƒ©ãƒ”ãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‰ç¶™ç¶šç¢ºèª
    const isRapid = document.body.classList.contains('rapid-mode');

    if(mode==='novel') {
        let txt=""; function tr(ul,d){Array.from(ul.children).forEach(li=>{txt+="ã€€".repeat(d)+li.querySelector('.row-text').value+"\n";tr(li.querySelector('ul'),d+1)})}
        tr(document.getElementById('rootList'),0); document.getElementById('novelText').value=txt;
        lv.style.display='none'; nv.style.display='block'; 
        
        // å°èª¬ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ©ãƒ”ãƒƒãƒ‰ONãªã‚‰è¡¨ç¤ºã€OFFãªã‚‰éš ã™
        ft.style.display = isRapid ? 'flex' : 'none';
        
    } else {
        const txt=document.getElementById('novelText').value, rt=document.getElementById('rootList'); rt.innerHTML='';
        const lines=txt.split('\n'), stack=[{l:-1,ul:rt}];
        lines.forEach(line=>{
            if(!line.trim())return; const idt=(line.match(/^(ã€€|\t|\s)+/)||[ ""])[0].replace(/ã€€/g,' ').replace(/\t/g,' ').length;
            let l=idt; if(l>stack[stack.length-1].l+1)l=stack[stack.length-1].l+1;
            while(stack.length>1 && stack[stack.length-1].l>=l)stack.pop();
            const li=addNode(line.trim(), stack[stack.length-1].ul); stack.push({l:l,ul:li.querySelector('ul')});
        });
        lv.style.display='block'; nv.style.display='none'; 
        ft.style.display = 'flex'; // æ§‹æˆãƒ¢ãƒ¼ãƒ‰ã¯å¸¸ã«è¡¨ç¤º
    }
    updateCount();
}

function toggleRapidMode() {
    document.body.classList.toggle('rapid-mode');
    const isRapid = document.body.classList.contains('rapid-mode');
    
    document.getElementById('mainMenu').classList.remove('show');
    
    // ãƒ•ãƒƒã‚¿ãƒ¼è¡¨ç¤ºåˆ¶å¾¡
    const ft = document.querySelector('.footer');
    if (currentMode === 'novel') {
        ft.style.display = isRapid ? 'flex' : 'none';
    } else {
        ft.style.display = 'flex';
    }

    if(isRapid) {
        document.getElementById('rapidInput').focus();
    }
}
function checkRapidEnter(e) { if(e.key === 'Enter') submitRapid(); }
function submitRapid() {
    const input = document.getElementById('rapidInput');
    const val = input.value;
    if(!val.trim()) return;

    if(currentMode === 'list') {
        const li = addNode(val, null);
        li.scrollIntoView({behavior:"smooth", block:"center"});
    } else {
        const ta = document.getElementById('novelText');
        ta.value += (ta.value ? "\n" : "") + val;
        ta.scrollTop = ta.scrollHeight;
    }
    pushHistory();
    input.value = ""; input.focus();
}

function toggleSelectMode() { document.body.classList.toggle('select-mode'); document.querySelectorAll('.node-box').forEach(b=>b.classList.remove('selected')); }
function handleNodeClick(c) { if(document.body.classList.contains('select-mode')){ c.parentElement.classList.toggle('selected'); updateCount(); } }
function getSel() { return Array.from(document.querySelectorAll('.node-box.selected')).map(b=>b.closest('li')); }
function moveIndent(d) {
    const t=getSel().length?getSel():[getFocusedLi()];
    t.forEach(li=>{ if(!li)return; if(d===1){const p=li.previousElementSibling;if(p){p.querySelector('ul').appendChild(li);p.querySelector('ul').style.display='block';}}else{const p=li.parentElement.closest('li');if(p)p.after(li);} }); pushHistory();
}
function moveItem(d) {
    const t=getSel(); if(!t.length)return;
    (d===1?t.reverse():t).forEach(li=>{ if(d===-1&&li.previousElementSibling)li.parentElement.insertBefore(li,li.previousElementSibling); if(d===1&&li.nextElementSibling)li.parentElement.insertBefore(li,li.nextElementSibling.nextElementSibling); }); pushHistory();
}
function deleteItem() { const t=getSel(); if(!t.length||!confirm(`${t.length}ä»¶å‰Šé™¤ï¼Ÿ`))return; t.forEach(li=>li.remove()); toggleSelectMode(); pushHistory(); }
function mergeNodes() {
    const t=getSel(); if(t.length<2){alert("2ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„");return;}
    const f=t[0]; let txt=f.querySelector('.row-text').value;
    for(let i=1;i<t.length;i++){ txt+="\n"+t[i].querySelector('.row-text').value; Array.from(t[i].querySelector('ul').children).forEach(k=>f.querySelector('ul').appendChild(k)); t[i].remove(); }
    f.querySelector('.row-text').value=txt; resize(f.querySelector('.row-text')); toggleSelectMode(); pushHistory();
}
function setNodeColorMenu() {
    const t=getSel(); if(!t.length)return;
    const c=prompt("è‰²(red,blue,green,yellow,purple,ç©ºç™½):", "red");
    t.forEach(li=>li.querySelector('.node-box').setAttribute('data-color',c)); toggleSelectMode(); pushHistory();
}
function toggleMemo(b) { b.closest('.node-box').querySelector('.node-memo').classList.toggle('show'); }
function toggleSearch() { document.getElementById('searchPanel').classList.toggle('show'); if(document.getElementById('searchPanel').classList.contains('show'))document.getElementById('searchInput').focus(); }
function runSearch() {
    const q=document.getElementById('searchInput').value, lst=document.getElementById('searchResultList'); lst.innerHTML='';
    document.querySelectorAll('.node').forEach(n=>n.classList.remove('hidden')); 
    if(!q)return;
    try {
        const re=new RegExp(q);
        document.querySelectorAll('.node').forEach(n => { const txt = n.querySelector('.row-text').value; if(!re.test(txt)) n.classList.add('hidden'); });
        document.querySelectorAll('.node:not(.hidden)').forEach(n => { let p = n.parentElement.closest('.node'); while(p) { p.classList.remove('hidden'); p=p.parentElement.closest('.node'); } });
        document.querySelectorAll('.row-text').forEach(ta => {
             if(!ta.closest('.node').classList.contains('hidden')) {
                 const d=document.createElement('div'); d.className='search-item'; d.innerText=ta.value.substring(0,30)+"...";
                 d.onclick=()=>{ ta.scrollIntoView({behavior:"smooth",block:"center"}); ta.parentElement.style.background="#fff3b8"; setTimeout(()=>ta.parentElement.style.background="",2000); toggleSearch(); };
                 lst.appendChild(d);
             }
        });
    } catch(e){alert("æ­£è¦è¡¨ç¾ã‚¨ãƒ©ãƒ¼");}
}
function toggleTemplate() { document.getElementById('tplPanel').classList.toggle('show'); document.getElementById('mainMenu').classList.remove('show'); }
function insertTemplate(t) {
    if(currentMode==='list'){const li=addNode(t,null); li.scrollIntoView();}
    else{const ta=document.getElementById('novelText'); const p=ta.selectionStart; ta.value=ta.value.slice(0,p)+t+ta.value.slice(p);}
    toggleTemplate(); pushHistory();
}
function updateCount() {
    let t=0,s=0;
    if(currentMode==='novel'){const ta=document.getElementById('novelText'); t=ta.value.length; s=ta.selectionEnd-ta.selectionStart;}
    else{document.querySelectorAll('.row-text').forEach(x=>t+=x.value.length); getSel().forEach(li=>s+=li.querySelector('.row-text').value.length);}
    document.getElementById('countInfo').innerHTML=`å…¨:${t}<br>é¸:${s}`;
}
function handleNovelInput(){updateCount();}
function toggleDark(){document.body.classList.toggle('dark-mode');}
function toggleMenu(){document.getElementById('mainMenu').classList.toggle('show');}
function getFocusedLi(){const ae=document.activeElement; return (ae&&ae.classList.contains('row-text'))?ae.closest('li'):null;}
function escapeHtml(s){if(!s)return"";return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','':'&quot;',"'":'&#039;'}[c]));}

function toggleImportExport() { document.getElementById('ioPanel').classList.toggle('show'); document.getElementById('mainMenu').classList.remove('show'); }
function getExportContent() {
    const scope = document.querySelector('input[name="exScope"]:checked').value;
    const isCode = document.getElementById('exCodeBlock').checked;
    let content = "";
    if (currentMode === 'novel') { content = document.getElementById('novelText').value; } else {
        function traverse(ul, depth) {
            let s = "";
            Array.from(ul.children).forEach(li => {
                if (scope === 'visible' && (li.classList.contains('hidden') || li.offsetParent === null)) return;
                if (scope === 'selected' && !li.querySelector('.node-box').classList.contains('selected')) return;
                s += "ã€€".repeat(depth) + li.querySelector('.row-text').value + "\n";
                s += traverse(li.querySelector('ul'), depth + 1);
            });
            return s;
        }
        if (scope === 'selected') {
            const sel = getSel(); if(!sel.length){alert("é¸æŠãªã—");return "";}
            sel.forEach(li=>{ content+=li.querySelector('.row-text').value+"\n"; });
        } else { content = traverse(document.getElementById('rootList'), 0); }
    }
    if (isCode) content = "```\n" + content + "\n```";
    return content;
}
function copyToClipboard() { navigator.clipboard.writeText(getExportContent()).then(()=>alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ")).catch(e=>alert(e)); }
function shareText() { if(navigator.share){navigator.share({title:'åŸ·ç­†ãƒé–“',text:getExportContent()});}else{alert("å…±æœ‰æœªå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã™");} }
function exportData(type) {
    let c = getExportContent(); if(!c && type!=='opml') return;
    if(type==='md'){ c = c.split('\n').map(l=>{const m=l.match(/^(ã€€+)(.*)/);return m?"  ".repeat(m[1].length)+"- "+m[2]:(l?"- "+l:"");}).join('\n'); }
    else if(type==='opml'){
        c=`<?xml version="1.0"?><opml version="2.0"><head><title>Export</title></head><body>`;
        function tr(ul){let s="";Array.from(ul.children).forEach(li=>{if(li.classList.contains('hidden'))return;s+=`<outline text="${escapeHtml(li.querySelector('.row-text').value)}">`+tr(li.querySelector('ul'))+`</outline>`;});return s;}
        c+=tr(document.getElementById('rootList'))+`</body></opml>`;
    }
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([c],{type:"text/plain"})); a.download = `export.${type}`; a.click();
}
function importFromClipboard() {
    navigator.clipboard.readText().then(t=>{ if(!t)return; document.getElementById('novelText').value=t; setMode('novel'); alert("è²¼ä»˜å®Œäº†"); toggleImportExport(); });
}
function importFile(input) {
    const f=input.files[0]; if(!f)return;
    const r=new FileReader();
    r.onload=e=>{
        const t=e.target.result;
        if(t.trim().startsWith("<?xml")){try{const i=parseOpml(t);document.getElementById('rootList').innerHTML="";buildTree(document.getElementById('rootList'),i);currentMode='list';document.querySelector('.m-btn:nth-child(1)').click();}catch(e){alert("Error");}}
        else{document.getElementById('novelText').value=t.replace(/^(\s*)[-*+]\s+/gm,(m,p)=>p+"");setMode('novel');setMode('list');}
        pushHistory(); toggleImportExport();
    }; r.readAsText(f);
}
function parseOpml(x){const p=new DOMParser(),d=p.parseFromString(x,"text/xml");function w(n){const c=[];Array.from(n.children).forEach(k=>{if(k.tagName==='outline')c.push({text:k.getAttribute('text')||"",children:w(k)});});return c;}return w(d.querySelector('body'));}
</script>
</body>
</html>
